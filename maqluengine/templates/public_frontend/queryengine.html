{% extends "public_frontend/tara_base.html" %}
{% load static %}


{% block content %}
<div class="main">

{% include "public_frontend/tara_subheader.html" %}

    <div class="main-content">

    
        <div class="query-engine-holder">
    
    
    
             <div id="master-query-engine">
                <form class="query-engine" method="post">
                {% csrf_token %} 
                <div class="search-title"><div class="tool-label">Master Query Engine Search Tool</div><div class="user-query-management"></div></div>
                <div class="main-query-frame">
                    <div class="all-queries">
             
                       
                    
                    </div> <!-- End of all-queries  container -->
                    


                    
                </div>
                <button id="add-query" class="btn add-query-btn" type="button">Add Query</button>
                <input type="submit" name="SEARCH" value="SEARCH"></input>
                </form>
            </div>
            
            
            
            
            
            
            <div id="query-stats">
                <div class='stats-header'>Query Progress</div> 
                <div class="progress">
                    <div id="query-progress-bar" class="active progress-bar progress-bar-striped" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="min-width:2em; width:0%; white-space: nowrap;text-align:left;padding-left:10px;">0%</div>
                </div>
                <div id="info-message">
                    
                </div>

            </div>
            
            <div id="all-results">
                
                
            </div>   
    
    
        </div>
    
    
    
    
    </div>
</div>


<!---------------------------------------------------------------------------------------------------------------------------------------------------------->    
<!-- ALL TEMPLATES CONTAINER (for cloning) ---------------------------------------------------------------------------------------------------------->
<!---------------------------------------------------------------------------------------------------------------------------------------------------------->    

<!-- NEW TERM FOR QUERY BOX------------------------------------------------------------------------------------------------------------------------>
    <div class="new-term term-clone" style="display:none">
        <div> 
            <button class="btn btn-info delete-term" type="button"><span class="glyphicon glyphicon-remove-circle">X</span></button>
            <select class="__ANDOR and-or-select">
                <option value="and">AND</option><option value="or">OR</option>
            </select>
        </div>
            
        <div><select class="rtype-list __RTYPE"></select> </div>
        <div><select class="deep-rtype-list __RTYPE-DEEP" disabled></select></div>
        
        <div class="and-or-options-select">
            <select class="__QCODE">
                <option value="0">Contains(Case Sensitive)</option>
                <option value="1">Contains</option>
                <option value="2">Matches Exact</option>
                <option value="3">Excludes</option>
                <option value="4">Is Null</option>
             </select>
        </div>
        <div>
        <input class="__TVAL" type="text">      
        </div>
    </div>

<!-- QUERY BOX ------------------------------------------------------------------------------------------------------------------------>    
    <div class="single-query single-query-clone __Q" style="display:none">
        <div class="main-query">
            <div class="query-project"><div>Project:</div><select class="project-list __P"><option value="none">None Selected</option></select></div>
            <div class="query-container">
                <div class="query-header"><div>Form Type</div><div>Record Type</div><div>Deep Record Type</div><div>Query Type</div><div>Search Term</div></div>
                <div class="query-terms">
                    <select class="formtype-list __FT" disabled></select>
                    <select class="rtype-list __RTYPE" disabled></select>
                    <select class="deep-rtype-list __RTYPE-DEEP" disabled></select>
                    <select class="__QCODE">
                        <option value="0">Contains(Case Sensitive)</option>
                        <option value="1">Contains</option>
                        <option value="2">Matches Exact</option>
                        <option value="3">Excludes</option>
                        <option value="4">Is Null</option>
                     </select>
                    <input class="__TVAL">
                </div>
                          
            </div>
            
            <div class="and-or-container">
            
            </div>
            
            <button class="btn btn-info and-or-add-btn" type="button">Add Term</button>
            <button class="btn delete-query" type="button"><span class="glyphicon glyphicon-remove-circle">X</span></button>
        </div>
        <div class="constraints-list primary">
            <div class="header">Primary Constraints</div>
            <div class="project-constraint" style="border-color: rgb(117, 255, 179); top: 12px;" queryid="1">
                <select class="rtype-list __RTYPE"><option value="1512__FRRT" class="FRRT-option">Area</option><option value="16482__FRAT">Associated Drawings</option><option value="1396__FRRT" class="FRRT-option">Associated Photos</option><option value="1469__FRRT" class="FRRT-option">Associated SU</option><option value="16472__FRAT">Associated Seasons</option><option value="16478__FRAT">FS-description</option><option value="16496__FRAT">FS-xGrid</option><option value="16501__FRAT">FS-xValue</option><option value="16476__FRAT">FS-yGrid</option><option value="16479__FRAT">FS-yValue</option><option value="1411__FRRT" class="FRRT-option">File Name</option><option value="17449__FRAT">File Name Test</option><option value="16484__FRAT">HasCard</option><option value="16508__FRAT">HasNotes</option><option value="16503__FRAT">HasPhoto</option><option value="16502__FRAT">HasProblems</option><option value="16480__FRAT">INT-logAccount</option><option value="16494__FRAT">INT-logDate</option><option value="16474__FRAT">INT-logIP</option><option value="16497__FRAT">INT-modAccount</option><option value="16487__FRAT">INT-modDate</option><option value="16499__FRAT">INT-modIP</option><option value="16486__FRAT">INT-selectedRes</option><option value="16498__FRAT">INT-tableRes</option><option value="16477__FRAT">ImageNumber</option><option value="16489__FRAT">Notes</option><option value="16483__FRAT">OC-dateCollected</option><option value="16473__FRAT">OC-description</option><option value="16493__FRAT">OC-descriptionAmended</option><option value="16488__FRAT">OC-drawingId</option><option value="16470__FRAT">OC-remarks</option><option value="16471__FRAT">OC-wasDrawn</option><option value="16506__FRAT">Object Card Condition</option><option value="16491__FRAT">Object Notes</option><option value="16490__FRAT">Object Type</option><option value="16507__FRAT">Old Object ID</option><option value="16505__FRAT">Photo Frame #s</option><option value="16475__FRAT">Photo Roll #s</option><option value="16509__FRAT">Photo Types</option><option value="16469__FRAT">SORT-objectNumber</option><option value="16492__FRAT">Season</option><option value="1485__FRRT" class="FRRT-option">Square ID</option><option value="16510__FRAT">artefact-id</option><option value="16481__FRAT">comments</option><option value="16495__FRAT">currentHelpTopic</option><option value="16485__FRAT">currentLayout</option><option value="1512__FRRT" class="FRRT-option">Area</option><option value="16482__FRAT">Associated Drawings</option><option value="1396__FRRT" class="FRRT-option">Associated Photos</option><option value="1469__FRRT" class="FRRT-option">Associated SU</option><option value="16472__FRAT">Associated Seasons</option><option value="16478__FRAT">FS-description</option><option value="16496__FRAT">FS-xGrid</option><option value="16501__FRAT">FS-xValue</option><option value="16476__FRAT">FS-yGrid</option><option value="16479__FRAT">FS-yValue</option><option value="1411__FRRT" class="FRRT-option">File Name</option><option value="17449__FRAT">File Name Test</option><option value="16484__FRAT">HasCard</option><option value="16508__FRAT">HasNotes</option><option value="16503__FRAT">HasPhoto</option><option value="16502__FRAT">HasProblems</option><option value="16480__FRAT">INT-logAccount</option><option value="16494__FRAT">INT-logDate</option><option value="16474__FRAT">INT-logIP</option><option value="16497__FRAT">INT-modAccount</option><option value="16487__FRAT">INT-modDate</option><option value="16499__FRAT">INT-modIP</option><option value="16486__FRAT">INT-selectedRes</option><option value="16498__FRAT">INT-tableRes</option><option value="16477__FRAT">ImageNumber</option><option value="16489__FRAT">Notes</option><option value="16483__FRAT">OC-dateCollected</option><option value="16473__FRAT">OC-description</option><option value="16493__FRAT">OC-descriptionAmended</option><option value="16488__FRAT">OC-drawingId</option><option value="16470__FRAT">OC-remarks</option><option value="16471__FRAT">OC-wasDrawn</option><option value="16506__FRAT">Object Card Condition</option><option value="16491__FRAT">Object Notes</option><option value="16490__FRAT">Object Type</option><option value="16507__FRAT">Old Object ID</option><option value="16505__FRAT">Photo Frame #s</option><option value="16475__FRAT">Photo Roll #s</option><option value="16509__FRAT">Photo Types</option><option value="16469__FRAT">SORT-objectNumber</option><option value="16492__FRAT">Season</option><option value="1485__FRRT" class="FRRT-option">Square ID</option><option value="16510__FRAT">artefact-id</option><option value="16481__FRAT">comments</option><option value="16495__FRAT">currentHelpTopic</option><option value="16485__FRAT">currentLayout</option></select>
                <select class="deep-rtype-list __RTYPE-DEEP" disabled></select>
                <button class="btn del-constraint-btn" type="button" style="display:none"><span class="glyphicon glyphicon-remove-circle"></span></button>
                <select class="__QCODE">
                    <option value="0">Contains(Case Sensitive)</option>
                    <option value="1">Contains</option>
                    <option value="2">Matches Exact</option>
                    <option value="3">Excludes</option>
                    <option value="4">Is Null</option>
                    <option value="5">All Unique Values</option>
                 </select>
                <div class="inputs"> 
                    <div><button class="delete-constraint-term" disabled>X</button><input class="__TVAL" type="text"></div>  
                </div>
                <button type="button" class="add-constraint-term">Add Term</button>
            </div>
        </div>
        <div class="constraints-list secondary">
            <div class="header">Secondary Constraints</div>
            <div class="project-constraint" style="border-color: rgb(117, 255, 179); top: 12px;" queryid="1">
                <select class="rtype-list __RTYPE"><option value="1512__FRRT" class="FRRT-option">Area</option><option value="16482__FRAT">Associated Drawings</option><option value="1396__FRRT" class="FRRT-option">Associated Photos</option><option value="1469__FRRT" class="FRRT-option">Associated SU</option><option value="16472__FRAT">Associated Seasons</option><option value="16478__FRAT">FS-description</option><option value="16496__FRAT">FS-xGrid</option><option value="16501__FRAT">FS-xValue</option><option value="16476__FRAT">FS-yGrid</option><option value="16479__FRAT">FS-yValue</option><option value="1411__FRRT" class="FRRT-option">File Name</option><option value="17449__FRAT">File Name Test</option><option value="16484__FRAT">HasCard</option><option value="16508__FRAT">HasNotes</option><option value="16503__FRAT">HasPhoto</option><option value="16502__FRAT">HasProblems</option><option value="16480__FRAT">INT-logAccount</option><option value="16494__FRAT">INT-logDate</option><option value="16474__FRAT">INT-logIP</option><option value="16497__FRAT">INT-modAccount</option><option value="16487__FRAT">INT-modDate</option><option value="16499__FRAT">INT-modIP</option><option value="16486__FRAT">INT-selectedRes</option><option value="16498__FRAT">INT-tableRes</option><option value="16477__FRAT">ImageNumber</option><option value="16489__FRAT">Notes</option><option value="16483__FRAT">OC-dateCollected</option><option value="16473__FRAT">OC-description</option><option value="16493__FRAT">OC-descriptionAmended</option><option value="16488__FRAT">OC-drawingId</option><option value="16470__FRAT">OC-remarks</option><option value="16471__FRAT">OC-wasDrawn</option><option value="16506__FRAT">Object Card Condition</option><option value="16491__FRAT">Object Notes</option><option value="16490__FRAT">Object Type</option><option value="16507__FRAT">Old Object ID</option><option value="16505__FRAT">Photo Frame #s</option><option value="16475__FRAT">Photo Roll #s</option><option value="16509__FRAT">Photo Types</option><option value="16469__FRAT">SORT-objectNumber</option><option value="16492__FRAT">Season</option><option value="1485__FRRT" class="FRRT-option">Square ID</option><option value="16510__FRAT">artefact-id</option><option value="16481__FRAT">comments</option><option value="16495__FRAT">currentHelpTopic</option><option value="16485__FRAT">currentLayout</option><option value="1512__FRRT" class="FRRT-option">Area</option><option value="16482__FRAT">Associated Drawings</option><option value="1396__FRRT" class="FRRT-option">Associated Photos</option><option value="1469__FRRT" class="FRRT-option">Associated SU</option><option value="16472__FRAT">Associated Seasons</option><option value="16478__FRAT">FS-description</option><option value="16496__FRAT">FS-xGrid</option><option value="16501__FRAT">FS-xValue</option><option value="16476__FRAT">FS-yGrid</option><option value="16479__FRAT">FS-yValue</option><option value="1411__FRRT" class="FRRT-option">File Name</option><option value="17449__FRAT">File Name Test</option><option value="16484__FRAT">HasCard</option><option value="16508__FRAT">HasNotes</option><option value="16503__FRAT">HasPhoto</option><option value="16502__FRAT">HasProblems</option><option value="16480__FRAT">INT-logAccount</option><option value="16494__FRAT">INT-logDate</option><option value="16474__FRAT">INT-logIP</option><option value="16497__FRAT">INT-modAccount</option><option value="16487__FRAT">INT-modDate</option><option value="16499__FRAT">INT-modIP</option><option value="16486__FRAT">INT-selectedRes</option><option value="16498__FRAT">INT-tableRes</option><option value="16477__FRAT">ImageNumber</option><option value="16489__FRAT">Notes</option><option value="16483__FRAT">OC-dateCollected</option><option value="16473__FRAT">OC-description</option><option value="16493__FRAT">OC-descriptionAmended</option><option value="16488__FRAT">OC-drawingId</option><option value="16470__FRAT">OC-remarks</option><option value="16471__FRAT">OC-wasDrawn</option><option value="16506__FRAT">Object Card Condition</option><option value="16491__FRAT">Object Notes</option><option value="16490__FRAT">Object Type</option><option value="16507__FRAT">Old Object ID</option><option value="16505__FRAT">Photo Frame #s</option><option value="16475__FRAT">Photo Roll #s</option><option value="16509__FRAT">Photo Types</option><option value="16469__FRAT">SORT-objectNumber</option><option value="16492__FRAT">Season</option><option value="1485__FRRT" class="FRRT-option">Square ID</option><option value="16510__FRAT">artefact-id</option><option value="16481__FRAT">comments</option><option value="16495__FRAT">currentHelpTopic</option><option value="16485__FRAT">currentLayout</option></select>
                <select class="deep-rtype-list __RTYPE-DEEP" disabled></select>
                <button class="btn del-constraint-btn" type="button" style="display:none"><span class="glyphicon glyphicon-remove-circle"></span></button>
                <select class="__QCODE">
                    <option value="0">Contains(Case Sensitive)</option>
                    <option value="1">Contains</option>
                    <option value="2">Matches Exact</option>
                    <option value="3">Excludes</option>
                    <option value="4">Is Null</option>
                    <option value="5">All Unique Values</option>
                 </select>
                 
                <div class="inputs"> 
                    <div><button class="delete-constraint-term" disabled>X</button><input class="__TVAL" type="text"></div>  
                </div>
                <button type="button" class="add-constraint-term">Add Term</button>
            </div>
        </div>
    </div>
    
<!-- CONSTRAINT INPUT ------------------------------------------------------------------------------------------------------------------------>
    <div class="constraint-input TEMPLATE" style="display:none;"><button class="delete-constraint-term">X</button><input class="__TVAL" type="text"></div>

 <!-- RESULTS WINDOW ------------------------------------------------------------------------------------------------------------------------>   
    <div class="project-results project-results-clone" style="display:none">
        <div class="query-pagination">
            <input class="pagination-query-json" value="" hidden disabled>
            <input class="pagination-results-count" value="" hidden disabled>
            <input class="pagination-results-list" value="" hidden disabled>
            <input class="pagination-rtypes-list" value="" hidden disabled>
            <div class="query-stats"><span class="query-title">Project Query Results</span></div>
            <div class="pagination-container" style="width: 70%;float: left;">

            </div>
        </div>
   
        <div class="view-table">
            <div class="scroll-container">
                <table class="view-table-body" class="table table-striped table-select" border="1px">
                    <tbody>
                    <!-- List of forms is generated here-->
                    </tbody>
                </table>
            </div>
            <div class="stats-graphic">
                <a class="download-stats">DOWNLOAD QUERY STATS AS CSV</a>
                <textarea class="csv-export-container" value="" hidden disabled></textarea>
                <div class="form-preview" hidden></div>
            </div>
        </div> 
                
    </div>
    
  
  
    <div class="details-frrt TEMPLATE" style="display:none;">
        <div class="header"></div>
        <div class="frrt-list">
            
        </div>

    </div>
    
    <div class="chart-tab TEMPLATE" style="display:none;"> 
        <div class="tab-button"></div>
        <div class="tab-content"></div>
    </div>
<!--^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^-->    
<!--^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^-->
<!--^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^-->   



{% endblock %}


{% block footer %}

    <!--   
    //================================================================================================================
    //
    //  This script acts as a standarized set of functions and variables that all templates in the maqlu engine need
    //  --to access and utilize. e.g. Because these scripts access the back-end API outside of a template, I needed
    //  --a way to access the API endpoint URIs so I store a list of the URIs and pass them as a template variables
    //  --that the rest of the included javascripts can utilize. I had contemplated just adding all the javascript to
    //  --each <template>.html file within <script> tags, but that will increase the file template size, and there will
    //  --be redundant code that can't be cached, nor edited easily in the future.
    //
    //  These global variables and Endpoints should be on every main admin template page 
    //
    //  It additionally, adds a CSRF token reader for the scripts to use POST AJAX with.
    //================================================================================================================
    -->
 
    <script>          
    //GLOBAL FUNCTIONS//
    function getAPIEndpoints(){
        return JSON.parse('{{api_urls|safe}}');
    }
    //GLOBALS VARIABLES//
    var RTYPE_LIST;
    var API_URLS = getAPIEndpoints();
    </script>

    <!-- ======================================================================================================== -->
    <!-- ======================================================================================================== -->
    <!-- ======================================================================================================== -->   


    <script src="{% static 'chart/Chart.min.js'  %}"></script>     
    <script src="{% static 'js/enki-thumbnail-popup.js'  %}"></script>  
        
    
    
    <script>
    //
    //  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!Eventually this script below should be in its own separate .js file for caching. Will leave
    //  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!as part of the template until the main development is done on the geospatial engine
    //
    // ***************************************START OF MASTER QUERY ENGINE ******************************************* 
    //----------------------------------------------------------------------------------------------------------------
    function showBusyGraphic(elementToCover){
        $busyIndicator = $('<div id="busy-indicator"><img src="/static/site-images/busy-indicator.gif"></img></div>');
        $(elementToCover).append($busyIndicator);
    }
    
    function removeBusyGraphic(){
        $('#busy-indicator').remove();
    }
    
    
    var QUERY_LOAD_FINISHED = false;
    var MOVE_TO_NEXT_QUERY = true;
    var MOVE_TO_NEXT_TERM = true;
    var ALL_QUERIES_FINISHED = false;
    var ALL_CONSTRAINTS_DEEP_LOADED = false;
    var MOVE_TO_NEXT_CONSTRAINT_QUERY = true;
    var PROGRESS_UUID = "";
    var alreadyHaveStats = false;
    var queryFinishedFasterThanAJAXCall = false;
    
    
    {% if user.permissions.saved_queries %}    
        var user_queries = {{user.permissions.saved_queries|safe}};
    {% else %}
        var user_queries;
    {% endif %}
    
    
    function loadAllSavedUserQueries(){
        //each 'key' of the query is the query's label
        if (user_queries){
            console.log(user_queries);
            var queries = Object.keys(user_queries);
            console.log(queries);
            for (var i = 0; i < user_queries.length; i++){
                var query = user_queries[i];
                $('#master-query-engine .load-query').append("<option value='"+JSON.stringify(query.query)+"'>"+query.label+'</option>');
            }
        }
    }
    
    
    $('.del-query').click( function(){
        if($('.load-query').val() != 'none'){
            var label = $('.load-query').find('option:selected').text();
            console.log(label);
            $.ajax({ url   : API_URLS['delete_user_profile_query'], type  : "GET", data  : [{name:"label", value:label}], // data to be submitted
                 success : function(returnedQuery){
                    console.log(returnedQuery);
                    $('.load-query').find('option:selected').remove();
                    $('.load-query').val('none');
                 }
                  
            });  
        }        
    
    });
    
    
    $('.load-query').change( function() {
        //empty our project query list and results list
        $('#all-results').empty();
        $('.all-queries').empty();
        $('.constraints-container').children().each( function(){
            $(this).empty();
        });
        var query_list = $(this).find('option:selected').val();
        
        //If we select "NONE" then reset our form
        if (query_list == "none") {
            //Add a new blank query element
            addNewProjectQuery();
        //Otherwise Load the query
        } else {
            //Start Our Busy Graphic to let the user know it's loading
            showBusyGraphic($('#master-query-engine'));
        
        
            //Reset our flag
            QUERY_LOAD_FINISHED = false;
            MOVE_TO_NEXT_QUERY = true;
            ALL_QUERIES_FINISHED = false;
            console.log(query_list);
            query_list = JSON.parse(query_list);
            query_list = JSON.parse(query_list);
            console.log(query_list);

            
            
            
            //This is essentially an asynchronous loop that wait for a single query to be loaded from our query list, before going on to the next.
            //Jscript isn't really made for multi-threading etc., so this is a way around that because all the select boxes are dynamically loaded.
            //This script essentially emulates a human being manually clicking each box to open up new options based on responding AJAX
            //THIS IS SO COMPLICATED BUT SEEMINGLY WORKS WITHOUT A HITCH--GOD FORGIVE ME FOR WHAT I HAVE DONE HERE
            var query_counter = 0;
            
            function loadQueryOneByOne() {
                setTimeout( function() {     
                console.log('$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$ CURRENT QUERY ------------------ '+query_counter);
                console.log(MOVE_TO_NEXT_QUERY);
                    if (MOVE_TO_NEXT_QUERY && query_counter < query_list.query_list.length){
                        MOVE_TO_NEXT_QUERY = false;
                      
                    
                        var loadedQuery = query_list.query_list[query_counter];
                        console.log(loadedQuery);
                        

                        
                        //Add a new query element and wait for it to be loaded before continuing
                        addNewProjectQuery();
                        
                        
                        function checkForProjectLoad(){
                                console.log('<!--------------------------Checking for Project to Load  : ' + QUERY_LOAD_FINISHED);
                            if(QUERY_LOAD_FINISHED == true){
                                QUERY_LOAD_FINISHED = false;
                                console.log("We did it?");
                                
                                $newestQuery = $('.all-queries').children().last();
                                //Select the queries project by PK(it's the <option>'s matching val()
                                $newestQuery.find('.project-list').val(loadedQuery.project_pk);
                                $newestQuery.find('.project-list').change();
                                console.log($newestQuery);
                                
                                //Setup a listener to know when the AJAX call that loads the first term is finished so we can continue loading the rest of the query
                                
                                function checkForFormtypeLoad(){
                                    if(QUERY_LOAD_FINISHED == true){
                                        console.log("Attempting to select the FormType?");
                                        QUERY_LOAD_FINISHED = false;
                                        //select the FormTypes
                                         $newestQuery.find('.query-container').find('.__FT').val(loadedQuery.formtype_pk);
                                         $newestQuery.find('.query-container').find('.__FT').addClass('loaded');
                                         $newestQuery.find('.query-container').find('.__FT').change();
                                         console.log("attempting a change in the __FT select");
                                         //Now setup the RTYPEs when they load
                                         function checkForRtypeLoad(){//--------------------------------------------------------------------------------------------------------------------------------
                                            if(QUERY_LOAD_FINISHED == true){
                                                
                                                console.log("Trying to select RTYPES?");
                                                QUERY_LOAD_FINISHED = false;
                                                
                                                //We'll loop through each term in the query and add new AND/OR's past the first one if needed through another asyncronous looped function
                                                var term_counter = 0;
                                                MOVE_TO_NEXT_TERM = true;
                                                function loadTermsOneByOne() {//************************************************************************************************************************
                                                    setTimeout( function() {     
                                                        if (MOVE_TO_NEXT_TERM && term_counter < loadedQuery.terms.length){
                                                                        MOVE_TO_NEXT_TERM = false;
                                                                        //If the first term use the .query-terms box
                                                                        $deepRTYPEParent = null;
                                                                        console.log(loadedQuery.project_label + " : " +loadedQuery.formtype_label + "   --" +loadedQuery.terms[term_counter].pk + "__" + loadedQuery.terms[term_counter].RTYPE + "    ------  " + loadedQuery.terms[term_counter].LABEL );
                                                                        if (term_counter == 0) {
                                                                            $newestQuery.find('.query-container .__RTYPE').val(loadedQuery.terms[term_counter].pk + "__" + loadedQuery.terms[term_counter].RTYPE );
                                                                            $newestQuery.find('.query-container .__RTYPE').addClass('loaded');
                                                                            $newestQuery.find('.query-container .__RTYPE').change();
                                                                            $newestQuery.find('.query-container .__QCODE').val(loadedQuery.terms[term_counter].QCODE);
                                                                            $newestQuery.find('.query-container .__TVAL').val(loadedQuery.terms[term_counter].TVAL);
                                                                            $deepRTYPEParent = $newestQuery.find('.query-container');
                                                                        //Otherwise add a new term
                                                                        } else {
                                                                            $newestQuery.find('.and-or-add-btn').click();
                                                                            $newTerm = $newestQuery.find('.and-or-container').children().last();
                                                                            $newTerm.find('.__RTYPE').val(loadedQuery.terms[term_counter].pk + "__" + loadedQuery.terms[term_counter].RTYPE );
                                                                            $newTerm.find('.__RTYPE').change();
                                                                            $newTerm.find('.__RTYPE').addClass('loaded');
                                                                            $newTerm.find('.__QCODE').val(loadedQuery.terms[term_counter].QCODE);
                                                                            $newTerm.find('.__TVAL').val(loadedQuery.terms[term_counter].TVAL);
                                                                            $newTerm.find('.__ANDOR').val(loadedQuery.terms[term_counter].ANDOR);
                                                                            $deepRTYPEParent = $newTerm;
                                                                        }
                                                                        console.log("<!------------------------------------------   " + term_counter);
                                                                        if (loadedQuery.terms[term_counter].hasOwnProperty("RTYPE-DEEP")){
                                                                            function checkForDeepRTYPELoad(){
                                                                                if(QUERY_LOAD_FINISHED == true){
                                                                                    console.log("Trying to select DEEP RTYPES?");
                                                                                    QUERY_LOAD_FINISHED = false;
                                                                                    console.log(term_counter);
                                                                                    $deepRTYPEParent.find('.__RTYPE-DEEP').addClass('loaded');
                                                                                    $deepRTYPEParent.find('.__RTYPE-DEEP').val(loadedQuery.terms[term_counter]['RTYPE-DEEP'])
                                                                                    $deepRTYPEParent.find('.__RTYPE-DEEP').change();
                                                                                    MOVE_TO_NEXT_TERM = true;
                                                                                    term_counter++;
                                                                                    console.log("term_counter:  " + term_counter + "     MOVE_TO_NEXT_TERM: " +MOVE_TO_NEXT_TERM);
                                                                                } else {
                                                                                    window.setTimeout(checkForDeepRTYPELoad, 100);
                                                                                }
                                                                            }
                                                                            window.setTimeout(checkForDeepRTYPELoad, 100);
                                                                        } else {
                                                                            MOVE_TO_NEXT_TERM = true;
                                                                            term_counter++;
                                                                        }
                                                                        console.log("term_counter:  " + term_counter + "     MOVE_TO_NEXT_TERM: " +MOVE_TO_NEXT_TERM);

                                                        } 
                                                            
                                                        if (term_counter >= loadedQuery.terms.length) {
                                                            query_counter++; 
                                                            MOVE_TO_NEXT_QUERY = true;
                                                            if(query_counter >= query_list.query_list.length) {removeBusyGraphic();ALL_QUERIES_FINISHED = true;};
                                                        } else {window.setTimeout(loadTermsOneByOne, 100);}
                                                        
                                                        //else { MOVE_TO_NEXT_QUERY = true; }
                                                    }, 100);
                                                }//************************************************************************************************************************
                                                loadTermsOneByOne();//Start Our loop!
                                                
                                            } else {
                                                console.log("Waiting for rtypes to load?");
                                                window.setTimeout(checkForRtypeLoad, 300);
                                            }
                                         }//--------------------------------------------------------------------------------------------------------------------------------
                                         window.setTimeout(checkForRtypeLoad, 300);
                                    } else {
                                        console.log("Waiting for formtypesto load?");
                                        window.setTimeout(checkForFormtypeLoad, 100);
                                    }
                                }
                                window.setTimeout(checkForFormtypeLoad, 100);
                            } else {
                                window.setTimeout(checkForProjectLoad, 100);
                            }
                        }

                        window.setTimeout(checkForProjectLoad, 100);
                        

                    }
                    if(query_counter < query_list.query_list.length){window.setTimeout(loadQueryOneByOne, 100);} else {} 
                }, 100)
            }
            loadQueryOneByOne();//Start Our loop!
            
            //Now Let's load our constraints--I wanted to keep this separate because the original asynch loop is complicated enough.
            //The queries will already be loaded now--so we'll keep the same structure of looping through each query, and finding the constraint boxes that match the same index.
            //The constraint RTYPE selectors will already be loaded--so we will only have a single async loop to determine whether or not it's a FRRT that's been selected--in which case
            //We'll have to load it's DEEP RTYPES before choosing the correct one.
            //Filling out the terms is a straight forward task of programmatically 'clicking' the 'add term' button the same number of times as the the length of the tval terms array
            //--**We can reuse the old variables for the loop control
            
            
            //Reset our flags
            MOVE_TO_NEXT_CONSTRAINT_QUERY = true;
            var query_constraint_counter = 0;
            function loadQueryConstraintsOneByOne() {
                console.log('$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$ CURRENT CONSTRAINT QUERY ------------------ '+query_constraint_counter);
                if (query_constraint_counter < query_list.query_list.length){
                    var loadedQuery = query_list.query_list[query_constraint_counter];
                    if ( "primary_constraints" in loadedQuery){
                    if (ALL_QUERIES_FINISHED){
                        setTimeout( function() {     
                        console.log('$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$ CURRENT CONSTRAINT QUERY ------------------ '+query_constraint_counter);
                        console.log(MOVE_TO_NEXT_CONSTRAINT_QUERY);
                            if (MOVE_TO_NEXT_CONSTRAINT_QUERY){
                                MOVE_TO_NEXT_CONSTRAINT_QUERY = false;
                                console.log(query_constraint_counter);
                                //Start looping through our queries and filling out their constraints
                               
                                console.log(loadedQuery);
                                
                                //First add ALL the terms necessary--they remain unaffected by the RTYPE selector and can be done syncronously
                                //PRIMARY constraints FIRST
                                if (loadedQuery.primary_constraints.terms.length > 0){
                                    //First load the initial term
                                    console.log(loadedQuery.primary_constraints.terms[0]);
                                    $('.all-queries').children().eq(query_constraint_counter).find('.constraints-list.primary').find('.__TVAL').val( loadedQuery.primary_constraints.terms[0]);
                                    $('.all-queries').children().eq(query_constraint_counter).find('.constraints-list.primary').find('.__QCODE').val( loadedQuery.primary_constraints.QCODE);
                                    //Because we already have a TVAL input by default--we skip the first one and only add more if needed
                                    for (x = 1; x < loadedQuery.primary_constraints.terms.length; x++) {
                                        var currentTVAL = loadedQuery.primary_constraints.terms[x];
                                        $primaryParent = $('.all-queries').children().eq(query_constraint_counter).find('.constraints-list.primary')
                                        $primaryParent.find('.add-constraint-term').click();
                                        $primaryParent.find('.inputs').children().eq(x).find('.__TVAL').val(currentTVAL);
                                    }
                                }
                                //SECONDARY constraints NEXT
                                if (loadedQuery.secondary_constraints.terms.length > 0){
                                    //First load the initial term
                                    $('.all-queries').children().eq(query_constraint_counter).find('.constraints-list.secondary').find('.__TVAL').val( loadedQuery.secondary_constraints.terms[0]);
                                    $('.all-queries').children().eq(query_constraint_counter).find('.constraints-list.secondary').find('.__QCODE').val( loadedQuery.secondary_constraints.QCODE);
                                    //Because we already have a TVAL input by default--we skip the first one and only add more if needed
                                    for (x = 1; x < loadedQuery.secondary_constraints.terms.length; x++) {
                                        var currentTVAL = loadedQuery.secondary_constraints.terms[x];
                                        $secondaryParent = $('.all-queries').children().eq(query_constraint_counter).find('.constraints-list.secondary')
                                        $secondaryParent.find('.add-constraint-term').click();
                                        $secondaryParent.find('.inputs').children().eq(x).find('.__TVAL').val(currentTVAL);
                                    }
                                }                        

                                //Choose our PRIMARY and SECONDARY RTYPE and activate the change() function to start the AJAX process
                                console.log(query_constraint_counter);
                                console.log(loadedQuery);
                                console.log(loadedQuery.primary_constraints.pk +"__"+loadedQuery.primary_constraints.RTYPE);
                                $('.all-queries').children().eq(query_constraint_counter).find('.constraints-list.primary').find('.__RTYPE').val( loadedQuery.primary_constraints.pk +"__"+loadedQuery.primary_constraints.RTYPE).change();
                                $('.all-queries').children().eq(query_constraint_counter).find('.constraints-list.secondary').find('.__RTYPE').val( loadedQuery.secondary_constraints.pk +"__"+loadedQuery.secondary_constraints.RTYPE).change();
                                
                                function checkForDeepRTYPELoad(){
                                    if(ALL_CONSTRAINTS_DEEP_LOADED){
                                        console.log("((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((( CONSTRAINTS -- Trying to select DEEP RTYPES?");
                                        ALL_CONSTRAINTS_DEEP_LOADED = false;
                                        //PRIMARY DEEP RTYPE SELECTOR
                                        if(loadedQuery.primary_constraints['RTYPE-DEEP']){
                                            $('.all-queries').children().eq(query_constraint_counter).find('.constraints-list.primary').find('.__RTYPE-DEEP').addClass('loaded');
                                            $('.all-queries').children().eq(query_constraint_counter).find('.constraints-list.primary').find('.__RTYPE-DEEP').val(loadedQuery.primary_constraints['RTYPE-DEEP'])
                                            $('.all-queries').children().eq(query_constraint_counter).find('.constraints-list.primary').find('.__RTYPE-DEEP').change();
                                        }
                                        //SECONDARY DEEP RTYPE SELECTOR
                                        if(loadedQuery.secondary_constraints['RTYPE-DEEP']){
                                            $('.all-queries').children().eq(query_constraint_counter).find('.constraints-list.secondary').find('.__RTYPE-DEEP').addClass('loaded');
                                            $('.all-queries').children().eq(query_constraint_counter).find('.constraints-list.secondary').find('.__RTYPE-DEEP').val(loadedQuery.secondary_constraints['RTYPE-DEEP'])
                                            $('.all-queries').children().eq(query_constraint_counter).find('.constraints-list.secondary').find('.__RTYPE-DEEP').change();
                                        }
                                        MOVE_TO_NEXT_CONSTRAINT_QUERY = true;
                                        query_constraint_counter++;
                                        console.log(query_constraint_counter);
                                    } else {
                                        window.setTimeout(checkForDeepRTYPELoad, 100);
                                    }
                                }
                                checkForDeepRTYPELoad();

                                                        

                             if(query_constraint_counter < query_list.query_list.length){window.setTimeout(loadQueryConstraintsOneByOne, 100);}   
                            } 
                        },100);
                        
                    } else {window.setTimeout(loadQueryConstraintsOneByOne, 100);};
                    }//End of primary constraints check
                }
            }
            loadQueryConstraintsOneByOne();//Start loading the constraints
        }
        
    });
    
    
    
    
    
    
    
     $('.save-query').click(function(){
        var currentQuery = convertQueryToJSON();
        console.log(currentQuery);
        if (currentQuery != "" && currentQuery != null){
            $.ajax({ url   : API_URLS['save_query_user'], type  : "GET", data  : [{name:"new_query", value: JSON.stringify(currentQuery)}, {name:"new_query_label", value:$('#master-query-engine .user-query-management input').val()}], // data to be submitted
                 success : function(returnedQuery){
                    console.log(returnedQuery);
                    window.alert($('#master-query-engine .user-query-management input').val() + " query successfully saved!");
                    }
                  
            });     
        }
    });
    
    
function ConvertQueryCountsToCSVString(stats_data, labels, counts){
    completedCSVString = 'Query Statistics for ' + stats_data.project + ' FormType: ' +stats_data.formtype + '\n';
    
    //Add Primary Graph stats
    completedCSVString += '"BASIC STATISTICS OF MAIN QUERY TERMS==================================================="\n';
    completedCSVString += '"Search Label","Query Count"\n';
    for (var i = 0; i < labels.length; i++) {
        completedCSVString += '"' + labels[i] + '","' + counts[i] + '"\n';
    }
    
    //Add Primary Constraints
    if ('primary_constraints' in stats_data){
        completedCSVString += '"PRIMARY CONSTRAINTS STATISTICS========================================================================="\n';
        completedCSVString += '"name","parent label","parent_term","qcode","record type","term value","count"\n';
        for (var i = 0; i < stats_data.primary_constraints.length; i++){
            var constraint = stats_data.primary_constraints[i];    
            completedCSVString += '"'+ constraint.name + '","' + constraint.parent_label  + '","' + constraint.parent_term + '","' + constraint.qcode + '","' + constraint.rtype + '","' + constraint.tval + '","' + constraint.count + '"\n';  
        }
    }    

    //Add Secondary Constraints
    if ('secondary_constraints' in stats_data){
        completedCSVString += '"SECONDARY CONSTRAINTS STATISTICS========================================================================="\n';
        completedCSVString += '"name","query term label","query term value","parent label","parent_term","qcode","record type","term value","count"\n';
        for (var i = 0; i < stats_data.secondary_constraints.length; i++){
            var constraint = stats_data.secondary_constraints[i];    
            completedCSVString += '"'+ constraint.name + '","' +  constraint.big_parent_label  + '","' + constraint.big_parent_term + '","' + constraint.parent_label  + '","' + constraint.parent_term + '","' + constraint.qcode + '","' + constraint.rtype + '","' + constraint.tval + '","' + constraint.count + '"\n';  
        }
    }    
    
    return completedCSVString;
    
}    
    
function createNewChart(jsondata, parentWindow){
    console.log(jsondata);
    //Clear our chart space (we do this because due to the AJAX, the page does not refresh. If the user submits another query, this
    //--container needs to be cleared as a precaution.
     $(parentWindow).find('.stats-graphic').find('.canvas-parent').remove()


        $labels = [];
        $counts = [];
        $colors = [];
        
        


    //LOOP THROUGH ALL OUR QUERY STATS
    for(q=0; q < jsondata.query_list.length; q++){
        //We're given JSON as the returned data--we need to convert that to a set of lists for the chat js to use
        $mainLabel = "";
        $currentQueryColor = 'rgba(' + (Math.floor(Math.random()*(245-115+1))+115) +','+(Math.floor(Math.random()*(245-115+1))+115)+','+(Math.floor(Math.random()*(255-225+1))+225)+', 1)';
        $thisQuery = jsondata.query_list[q];
        
       // $constraintDatasetLabel = $thisQuery.rtype_name;
        
        
        //Setup our labels and counts
        for(t=0;t<$thisQuery.all_terms.length;t++){
            $thisTerm = $thisQuery.all_terms[t];
            //Update the constraint dataset label
           // $constraintDatasetLabel += " : " + $thisTerm.TVAL ;
            $qcode = '';
            //Translate the QCODE
            if($thisTerm.QCODE == 0) $qcode = 'contains'; else if($thisTerm.QCODE == 1)$qcode = 'contains(CS)'; else if($thisTerm.QCODE == 2)$qcode = 'exactly'; else if($thisTerm.QCODE == 3)$qcode = 'excludes'; else if($thisTerm.QCODE == 4)$qcode = 'is Null'; 
            if(t == 0)$labels.push($thisQuery.rtype_name + " : "+ $qcode +" :" + $thisTerm.TVAL);
            else $labels.push($thisTerm['T-ANDOR'] + " : " + $thisQuery.rtype_name + " " + $qcode +" : '" + $thisTerm.TVAL+"'");
            $counts.push($thisTerm.count);
            if (jsondata.query_list.length == 1) $colors.push('rgba(' + (Math.floor(Math.random()*(245-115+1))+115) +','+(Math.floor(Math.random()*(245-115+1))+115)+','+(Math.floor(Math.random()*(255-225+1))+225)+', 1)');        
            else $colors.push($currentQueryColor);
        }
        
        if ($thisQuery.ANDOR == 'or' && q != jsondata.query_list.length - 1) {
            $labels.push("Count After Above Additions");
            $counts.push($thisQuery.additions);
            $colors.push('rgba(' + (Math.floor(Math.random()*(245-115+1))+115) +','+(Math.floor(Math.random()*(245-115+1))+115)+','+(Math.floor(Math.random()*(255-225+1))+225)+', 1)');        
        } else if ($thisQuery.ANDOR == 'and') {
            $labels.push("Count After Above Intersection");
            $counts.push($thisQuery.intersections);
            $colors.push('rgba(' + (Math.floor(Math.random()*(245-115+1))+115) +','+(Math.floor(Math.random()*(245-115+1))+115)+','+(Math.floor(Math.random()*(255-225+1))+225)+', 1)');        
        }
        

    }   
    
    
    
    //----------------------------------------------------------------------------------------------------------------------------------
    //  ADD BASIC GRAPH
    //
    //Label the data
    $mainLabel = jsondata.formtype + " Query";
    //Add a total count if there is atleast one query with atleast 2 terms
    if(jsondata.query_list.length > 1 || jsondata.query_list[0].all_terms.length > 1){
        $labels.push("Total Count of Matches");
        $counts.push(jsondata.count);
        $colors.push('rgba(' + (Math.floor(Math.random()*(245-1970+1))+70) +','+(Math.floor(Math.random()*(245-70+1))+70)+','+(Math.floor(Math.random()*(255-70+1))+70)+', 1)');        
    }
    //Setup a blank chart
    $emptyChartParent = $('.chart-tab.TEMPLATE').clone(true);
    $emptyChartParent.removeClass('TEMPLATE');
    $emptyChartParent.show();
    $emptyChartParent.find('.tab-button').addClass('basic');
    $emptyChartParent.find('.tab-button').html('Basic Breakdown');
    $emptyChartParent.find('.tab-button').click();
    $emptyChart = $('<canvas id="myChart" width="100%" height="400px"></canvas>');
    $emptyChartParent.find('.tab-content').append($emptyChart);
    
    //-----------------------------------------------------------------------------------------------------------------------------------------------------------
    // BASIC QUERY BREAK DOWN--This chart just breaks down the basic query without any constraints being applied and shows which terms produced what results etc.          
    // HORIZONTAL BAR CHART                
    var myBarChart = new Chart( $emptyChart, {
        type: 'horizontalBar',
        data: { labels: $labels, datasets: [{data: $counts,backgroundColor: $colors,label: $mainLabel,}] },
        legend: {display: false },
        options: {
            title:{display: false},
            barDatasetSpacing : 10, barValueSpacing : 10, responsive: true, maintainAspectRatio: false,
            scales: {   yAxes: [{categoryPercentage: 1.0, barPercentage: 1.0, ticks: {beginAtZero:true}}],
                        xAxes: [{categoryPercentage: 1.0, barPercentage: 1.0, ticks: {beginAtZero:true}}]
            }
        }
        });
        console.log(myBarChart);
    //Finally, add the chart to the query graphs container
    $(parentWindow).find('.stats-graphic').append($emptyChartParent);  
    //Add the listener that allows another tab to open when clicking on a specific bar in this chart to show that specific query
    $emptyChart.click( function(evt){open_form(evt, jsondata, jsondata.query_list)});
    //Our open form function--the one that pops up the selected bar query in another tab
    function open_form(evt, json_data, json_query){
        console.log(jsondata);
        var activePoints = myBarChart.getElementsAtEvent(evt);
        if (activePoints[0]) {
            var chartData = activePoints[0]['_chart'].config.data;
            var idx = activePoints[0]['_index'];

            var label = chartData.labels[idx];
            var value = chartData.datasets[0].data[idx];
            console.log(label +  " : "  + value);
            
            var new_window = window.location.href + "?starter_query="+encodeURIComponent(JSON.stringify(json_query[idx].original_query));
            var win = window.open(new_window, '_blank');
            if (!win) {
                alert('Please allow popups for this website');
            }
            return false;
        }
        // => activePoints is an array of points on the canvas that are at the same position as the click event.
    }
        
    //----------------------------------------------------------------------------------------------------------------------------------
    //  PRIMARY CONSTRAINTS GRAPH
    //   

    if (jsondata.primary_constraints.length > 0){  
        //We need to loop through our primary constraints--each group will be determined in the loop by a new 'constraint term' value
        var primary_constraints = jsondata.primary_constraints; 
        var primaryDatasets = [];  //These are the datasets that are groups of the original query terms, grouped by each constraint term
        var primaryLabels = []; //These are the labels for EACH dataset grouping--or the actual constraint
        var countList = [];
        
        var lastTVAL = '';
        console.log('ABOUT TO HIT PRIMARY CONSTRAINTS    ' +primary_constraints.length)
        for (p=0; p < primary_constraints.length; p++){
            var constraint = primary_constraints[p];
            console.log(constraint.parent_term + "   :  " + lastTVAL);
            if(constraint.parent_term != lastTVAL){
                if (p!= 0){
                    var newDataset = {}
                    var lastConstraint = primary_constraints[p-1];
                    var qcode = '';
                    //Translate the QCODE
                    if(constraint.QCODE == 0) qcode = 'contains(CS)'; else if(constraint.QCODE == 1)qcode = 'contains'; else if(constraint.QCODE == 2)qcode = 'exactly'; else if(constraint.QCODE == 3)qcode = 'excludes'; else if(constraint.QCODE == 4)qcode = 'is Null'; 
                    newDataset['backgroundColor'] = 'rgba(' + (Math.floor(Math.random()*(245-115+1))+115) +','+(Math.floor(Math.random()*(245-115+1))+115)+','+(Math.floor(Math.random()*(255-225+1))+225)+', 1)';
                    newDataset['data'] = countList.slice();
                    newDataset['label'] = lastConstraint.parent_label + ": " + qcode + ": " + lastConstraint.parent_term;
                    primaryDatasets.push(newDataset);
                }
                countList = [];
            }
            
            countList.push(constraint.count);
            lastTVAL = constraint.parent_term;
            //Make a list of labels ONCE through the first iteration of constraint values
            if (primaryDatasets.length == 0) primaryLabels.push(primary_constraints[p].name + "= " + primary_constraints[p].tval);
            
            //Also--if this is our LAST iteration then go ahead and populate the list(it won't happen otherwise--a bit sloppy to do it this way, but on a time line here.
            if (p == primary_constraints.length-1){
                    var lastConstraint;
                    //We need to make sure to account if the array has ONLY 1 item in it--once again, part of the sloppy fix.
                    if(primary_constraints.length == 1)lastConstraint = primary_constraints[p];
                    else lastConstraint = primary_constraints[p-1];
                    console.log(lastConstraint);
                    var newDataset = {}
                    
                    var qcode = '';
                    //Translate the QCODE
                    if(constraint.QCODE == 0) qcode = 'contains(CS)'; else if(constraint.QCODE == 1)qcode = 'contains'; else if(constraint.QCODE == 2)qcode = 'exactly'; else if(constraint.QCODE == 3)qcode = 'excludes'; else if(constraint.QCODE == 4)qcode = 'is Null'; 
                    newDataset['backgroundColor'] = 'rgba(' + (Math.floor(Math.random()*(245-115+1))+115) +','+(Math.floor(Math.random()*(245-115+1))+115)+','+(Math.floor(Math.random()*(255-225+1))+225)+', 1)';
                    newDataset['data'] = countList.slice();
                    newDataset['label'] = lastConstraint.parent_label + ": " + qcode + ": " + lastConstraint.parent_term;
                    primaryDatasets.push(newDataset);
            }        
        }
        
       
            console.log(primaryDatasets);
            console.log(primaryLabels);
            
            //Setup a blank chart
            $emptyPrimaryChartParent = $('.chart-tab.TEMPLATE').clone(true);
            $emptyPrimaryChartParent.removeClass('TEMPLATE');
            $emptyPrimaryChartParent.show();
            $emptyPrimaryChartParent.find('.tab-button').addClass('primary');
            $emptyPrimaryChartParent.find('.tab-button').html('Primary Constraints');
            var barHeight = "400";
            if(primaryDatasets.length >= 8 || primaryDatasets[0].data.length >= 8) barHeight = "1000"; 
            if(primaryDatasets.length >= 15 || primaryDatasets[0].data.length >= 15) barHeight = "2400"; 
            if(primaryDatasets.length >= 25 || primaryDatasets[0].data.length >= 25) barHeight = "3600"; 
            $emptyPrimaryChart = $('<canvas id="myChartHorizontalPrimary" width="100%" height="'+barHeight+'"></canvas>');
            $emptyPrimaryChartContainer = $('<div class="chart-parent"></div>');
            $emptyPrimaryChartContainer.append($emptyPrimaryChart);
            $emptyPrimaryChartParent.find('.tab-content').append($emptyPrimaryChartContainer);
            $(parentWindow).find('.stats-graphic').append($emptyPrimaryChartParent);
            
            var myPrimaryChart = new Chart( $emptyPrimaryChart, {
                type: 'horizontalBar',
                data: { labels: primaryLabels, datasets: primaryDatasets },
                legend: {  display: false },
                options: { title:{display: false},barDatasetSpacing : 10, barValueSpacing : 10,responsive: true,maintainAspectRatio: false,
                    scales: { yAxes: [{categoryPercentage: 1.0, barPercentage: 1.0, ticks: { beginAtZero:true}}],
                              xAxes: [{ categoryPercentage: 1.0, barPercentage: 1.0,ticks: {beginAtZero:true }}]
                            }
                }
                });
            
            //Setup a Pie Chart for each primary constraint
            //We will setup a Pie chart for each primary constraint--by looping through our existing primary constraints datasets
            //and setting each indexed count value and label in a separate dataset
            
            //First we use the number of data counts in ANY of the datasets(we arbitrarily use index 0 here--but it also ensures we won't run into IndexOutOfRange errors if there are less query terms than the index being used.
            //  --This count will determine how many primary constraints there are and how many pie charts need to be created
            for (var count_index = 0; count_index < primaryDatasets[0].data.length; count_index++){
                $countsList = [];
                $labelsList = [];
                $datasetsColors = [];
                for (var i = 0; i < primaryDatasets.length; i++){
                    $countsList.push(primaryDatasets[i].data[count_index]);
                    $labelsList.push(primaryDatasets[i].label);
                    $datasetsColors.push(primaryDatasets[i].backgroundColor);
                }
                
                    var thisMainLabel = primaryLabels[count_index];

                    var pieHeight = "400";
                    if(primaryDatasets.length >= 4) pieHeight = "500"; 
                    if(primaryDatasets.length >= 8) pieHeight = "800"; 
                    //For our percentage of 'total assemblage' of the queried formtype we need to add an additional data point which is the difference
                    //--between the total number of available forms(given in the query) and the total of the current data counts found
                    var sumOfQueryCounts = 0;
                    for (var i in $countsList) {
                        sumOfQueryCounts += $countsList[i];
                    }
                    $newCountsList = $countsList.slice();
                    $newLabelsList = $labelsList.slice();
                    $newColorsList = $datasetsColors.slice();
                    $newCountsList.push(parseInt(jsondata.all_forms_count) - sumOfQueryCounts);
                    $newLabelsList.push("Remaining Non-Queried Forms of " +jsondata.formtype);
                    $newColorsList.push('rgba(0,0,0,1)');
                    $emptyPieChart = $('<canvas id="myPieTotalChart'+count_index+'" width="400" height="'+pieHeight+'"></canvas>');
                    $emptyPieChartContainer = $('<div class="chart-parent"></div>');
                    $emptyPieChartContainer.append($emptyPieChart);
                    $emptyPrimaryChartParent.find('.tab-content').append($emptyPieChartContainer);
                        
                    var myPieChart = new Chart( $emptyPieChart, {
                        type: 'doughnut',
                        data: {datasets: [{data: $newCountsList,backgroundColor: $newColorsList,label: thisMainLabel}],  labels: $newLabelsList},
                        options: { cutoutPercentage: 40, title: { display: true, text: thisMainLabel + " : Proportionate to sum of all forms of this Formtype"}, responsive: true,
                            tooltips: {
                                callbacks: {
                                    label: function(tooltipItem, data) {
                                        var allData = data.datasets[tooltipItem.datasetIndex].data;
                                        var tooltipLabel = data.labels[tooltipItem.index];
                                        var tooltipData = allData[tooltipItem.index];
                                        var total = jsondata.all_forms_count;
                                        var tooltipPercentage = Math.round((tooltipData / total) * 100);
                                        return tooltipLabel + ': ' + tooltipData + ' (' + tooltipPercentage + '%)';
                                    }
                                }
                            }
                        }
                    });
                    
                
            }
           
    }    
    //----------------------------------------------------------------------------------------------------------------------------------
    //  SECONDARY CONSTRAINTS GRAPH
    //
    //We need to loop through our primary constraints--each group will be determined in the loop by a new 'constraint term' value
     
    
    if (jsondata.secondary_constraints.length > 0){  
        var secondary_constraints = jsondata.secondary_constraints;
        var secondaryDatasets = [];  //These are the datasets that are groups of the original query terms, grouped by each constraint term
        var secondaryLabels = []; //These are the labels for EACH dataset grouping--or the actual constraint
        var secondaryCountList = [];
        
        var lastSecondaryTVAL = '';
        console.log('ABOUT TO HIT SECONDARY CONSTRAINTS    ' +secondary_constraints.length)
        for (p=0; p < secondary_constraints.length; p++){
            var constraint = secondary_constraints[p];
            console.log(constraint.parent_term + constraint.big_parent_term + "   :  " + lastSecondaryTVAL);
            if(constraint.parent_term + constraint.big_parent_term != lastSecondaryTVAL){
                if (p!= 0){
                    var newDataset = {}
                    var lastConstraint = secondary_constraints[p-1];
                    var qcode = '';
                    //Translate the QCODE
                    if(constraint.QCODE == 0) qcode = 'contains(CS)'; else if(constraint.QCODE == 1)qcode = 'contains'; else if(constraint.QCODE == 2)qcode = 'exactly'; else if(constraint.QCODE == 3)qcode = 'excludes'; else if(constraint.QCODE == 4)qcode = 'is Null'; 
                    newDataset['backgroundColor'] = 'rgba(' + (Math.floor(Math.random()*(245-115+1))+115) +','+(Math.floor(Math.random()*(245-115+1))+115)+','+(Math.floor(Math.random()*(255-225+1))+225)+', 1)';
                    newDataset['data'] = secondaryCountList.slice();
                    newDataset['label'] = lastConstraint.parent_label + ": " + qcode + ": " + lastConstraint.parent_term + " => " + lastConstraint.big_parent_label + " : " +  lastConstraint.big_parent_term;
                    secondaryDatasets.push(newDataset);
                }
                secondaryCountList = [];
            }
            
            secondaryCountList.push(constraint.count);
            lastSecondaryTVAL = constraint.parent_term + constraint.big_parent_term;
            //Make a list of labels ONCE through the first iteration of constraint values
            if (secondaryDatasets.length == 0) secondaryLabels.push(secondary_constraints[p].name + "= " + secondary_constraints[p].tval);
            
            //Also--if this is our LAST iteration then go ahead and populate the list(it won't happen otherwise--a bit sloppy to do it this way, but on a time line here.
            if (p == secondary_constraints.length-1){
                    var lastConstraint;
                    //We need to make sure to account if the array has ONLY 1 item in it--once again, part of the sloppy fix.
                    if(secondary_constraints.length == 1)lastConstraint = secondary_constraints[p];
                    else lastConstraint = secondary_constraints[p-1];
                    var newDataset = {}
                    var qcode = '';
                    //Translate the QCODE
                    if(constraint.QCODE == 0) qcode = 'contains(CS)'; else if(constraint.QCODE == 1)qcode = 'contains'; else if(constraint.QCODE == 2)qcode = 'exactly'; else if(constraint.QCODE == 3)qcode = 'excludes'; else if(constraint.QCODE == 4)qcode = 'is Null'; 
                    newDataset['backgroundColor'] = 'rgba(' + (Math.floor(Math.random()*(245-115+1))+115) +','+(Math.floor(Math.random()*(245-115+1))+115)+','+(Math.floor(Math.random()*(255-225+1))+225)+', 1)';
                    newDataset['data'] = secondaryCountList.slice();
                    newDataset['label'] = lastConstraint.parent_label + ": " + qcode + ": " + lastConstraint.parent_term + " => " + lastConstraint.big_parent_label + " : " +  lastConstraint.big_parent_term;
                    secondaryDatasets.push(newDataset);
            }        
        }
        
        
            console.log(secondaryDatasets);
            console.log(secondaryLabels);
            //Setup a blank chart
            $emptySecondaryChartParent = $('.chart-tab.TEMPLATE').clone(true);
            $emptySecondaryChartParent.removeClass('TEMPLATE');
            $emptySecondaryChartParent.show();
            $emptySecondaryChartParent.find('.tab-button').addClass('secondary');
            $emptySecondaryChartParent.find('.tab-button').html('Secondary Constraints');
            $emptySecondaryChartContainer = $('<div class="chart-parent"></div>');
            
            var secondBarHeight = "400";
            var secondaryFontSize = 10;
            if(secondaryDatasets.length >= 8 || secondaryDatasets[0].data.length >= 8){secondBarHeight = "1000"; secondaryFontSize = 9;}
            if(secondaryDatasets.length >= 15 || secondaryDatasets[0].data.length >= 15) {secondBarHeight = "2400"; secondaryFontSize = 8; }
            if(secondaryDatasets.length >= 25 || secondaryDatasets[0].data.length >= 25) {secondBarHeight = "3600"; secondaryFontSize = 6;}
            $emptySecondaryChart = $('<canvas id="myChartHorizontalSecondary" width="100%" height="'+secondBarHeight+'"></canvas>');            
            
            $emptySecondaryChartContainer.append($emptySecondaryChart);
            $emptySecondaryChartParent.find('.tab-content').append($emptySecondaryChartContainer);
            $(parentWindow).find('.stats-graphic').append($emptySecondaryChartParent);

            var emptySecondaryChart = new Chart( $emptySecondaryChart, {
                type: 'horizontalBar',
                data: { labels: secondaryLabels, datasets: secondaryDatasets },
                legend: {  display: false },
                options: { title:{display: false},barDatasetSpacing : 10, barValueSpacing : 10,responsive: true,maintainAspectRatio: false,
                    scales: { yAxes: [{categoryPercentage: 1.0, barPercentage: 1.0, ticks: { beginAtZero:true}}],
                              xAxes: [{ categoryPercentage: 1.0, barPercentage: 1.0,ticks: {beginAtZero:true }}]
                            },
                    legend: { labels: {fontSize:8} }
                }
                });



            //Setup a Pie Chart for each primary constraint
            //We will setup a Pie chart for each primary constraint--by looping through our existing primary constraints datasets
            //and setting each indexed count value and label in a separate dataset
            
            //First we use the number of data counts in ANY of the datasets(we arbitrarily use index 0 here--but it also ensures we won't run into IndexOutOfRange errors if there are less query terms than the index being used.
            //  --This count will determine how many secondary constraints there are and how many pie charts need to be created
            for (var count_index = 0; count_index < secondaryDatasets[0].data.length; count_index++){
                $countsList = [];
                $labelsList = [];
                $datasetsColors = [];
                for (var i = 0; i < secondaryDatasets.length; i++){
                    $countsList.push(secondaryDatasets[i].data[count_index]);
                    $labelsList.push(secondaryDatasets[i].label);
                    $datasetsColors.push(secondaryDatasets[i].backgroundColor);
                }
                
                    var thisMainLabel = secondaryLabels[count_index];
                    if (thisMainLabel.length > 20) thisMainLabel = [];
                    var pieHeight = "400";
                    if(secondaryDatasets.length >= 4) pieHeight = "500"; 
                    if(secondaryDatasets.length >= 8) pieHeight = "800"; 
                    
                    //For our percentage of 'total assemblage' of the queried formtype we need to add an additional data point which is the difference
                    //--between the total number of available forms(given in the query) and the total of the current data counts found
                    var sumOfQueryCounts = 0;
                    for (var i in $countsList) {
                        sumOfQueryCounts += $countsList[i];
                    }
                    $newCountsList = $countsList.slice();
                    $newLabelsList = $labelsList.slice();
                    $newColorsList = $datasetsColors.slice();
                    $newCountsList.push(parseInt(jsondata.all_forms_count) - sumOfQueryCounts);
                    $newLabelsList.push("Remaining Non-Queried Forms of " +jsondata.formtype);
                    $newColorsList.push('rgba(0,0,0,1)');
                    $emptyPieChart = $('<canvas id="mySecondaryPieTotalChart'+count_index+'" width="400" height="'+pieHeight+'"></canvas>');
                    $emptyPieChartContainer = $('<div class="chart-parent"></div>');
                    $emptyPieChartContainer.append($emptyPieChart);
                    $emptySecondaryChartParent.find('.tab-content').append($emptyPieChartContainer);
                        
                    var myPieChart = new Chart( $emptyPieChart, {
                        type: 'doughnut',
                        data: {datasets: [{data: $newCountsList,backgroundColor: $newColorsList,label: thisMainLabel}],  labels: $newLabelsList},
                        options: { cutoutPercentage: 40, title: { display: true, text: thisMainLabel + " : Proportionate to sum of all forms of this Formtype"}, responsive: true,
                            tooltips: {
                                callbacks: {
                                    label: function(tooltipItem, data) {
                                        var allData = data.datasets[tooltipItem.datasetIndex].data;
                                        var tooltipLabel = data.labels[tooltipItem.index];
                                        var tooltipData = allData[tooltipItem.index];
                                        var total = jsondata.all_forms_count;
                                        var tooltipPercentage = Math.round((tooltipData / total) * 100);
                                        return tooltipLabel + ': ' + tooltipData + ' (' + tooltipPercentage + '%)';
                                    }
                                }
                            }
                        }
                    });
                    
                
            }

                
            
    }
    //Handle our CSV export of the data and save it in a hidden element
    var csvExport = ConvertQueryCountsToCSVString(jsondata, $labels, $counts);
    $emptyChartParent.parent().find('.download-stats')[0].href = window.URL.createObjectURL(new Blob([csvExport], {type: 'text/csv'}));
    $emptyChartParent.parent().find('.download-stats')[0].download = "TARA_"+jsondata.project + " -- " + $mainLabel+".csv";
        
}
   
   
   function previewForm(theButton){
        form_pk = $(theButton).attr('form_pk');
        $detailsPane = $(theButton).parent().parent().parent().parent().parent().parent().find('.form-preview');
        console.log($(theButton));
        console.log($(theButton).parent().parent().parent().parent().parent().parent());
        console.log($detailsPane);
        console.log('------------------------------------------------------------------------------')
        $detailsPane.empty();
        $detailsPane.show();
        $.ajax({ url   : API_URLS['get_form_rtypes'], type  : "GET", data  : [{name:"form_pk", value:form_pk}], // data to be submitted
         success : function(returnedQuery){
            console.log(returnedQuery);
            $detailsPane.append('<div class="form-header">'+returnedQuery.formtype_name + ': ' +returnedQuery.form_name+'<div class="remove-form-preview">X</div></div>');
            returnedQuery.rtype_list.forEach(function(rtype){
                console.log(rtype);
                if (rtype.rtype == "FRAT"){
                    $detailsPane.append('<div class="frat-entry"><div class="frat-label">'+rtype.rtype_label+'</div><div class="frat-value">'+rtype.rval.value+'</div></div>');
                } else if (rtype.rtype == "FRRT"){ 
                    $newFRRT = $('.details-frrt.TEMPLATE').clone(true);
                    $newFRRT.removeClass('TEMPLATE');
                    $newFRRT.show();
                    $newFRRT.find('.header').html(rtype.rtype_label);
                    for (var i in rtype.rval){
                        var rval = rtype.rval[i];
                        $newFRRT.find('.frrt-list').append("<div class='frrt-entry'><img class='enki-img-popup' src='"+rval.thumbnail+"'></img><a href='"+rval.url+"'><span>"+rval.name+"</span></a></div>");
                    }
                    $detailsPane.append($newFRRT);
                } else if (rtype.rtype == "BACK_FRRT"){ 
                    $newFRRT = $('.details-frrt.TEMPLATE').clone(true);
                    $newFRRT.removeClass('TEMPLATE');
                    $newFRRT.show();
                    $newFRRT.find('.header').html("References By: " + rtype.formtype_name);
                    for (var i in rtype.rval){
                        var rval = rtype.rval[i];
                        $newFRRT.find('.frrt-list').append("<div class='frrt-entry'><img class='enki-img-popup' src='"+rval.thumbnail+"'></img><a href='"+rval.url+"'><span>"+rval.form_name+"</span></a></div>");
                    }
                    $detailsPane.append($newFRRT);
                }
            });
            //Activate the iamge popup for the thumbnails
            //--This will require the enki-thumbnail-popup.js to be included on this page
            updateImagePopup();
            $('.remove-form-preview').click( function() {
                $(this).parent().parent().hide();
            });
         }
          
        });  
   }
   
   
    function buildPageNavigationBar(numOfResults, currentPage, currentQueryJson, currentResultsWindow, pagination_form_list, rtype_list){
        $currentResultsWindow = $(currentResultsWindow);
        
        console.log('Is it working?*****************************');
        var resultsPerPage = 25;
        
        //add our queryjson to the hidden pagination input
        $currentResultsWindow.find('.pagination-query-json').val(currentQueryJson);
        $currentResultsWindow.find('.pagination-results-count').val(numOfResults)
        $currentResultsWindow.find('.pagination-results-list').val(pagination_form_list);
        $currentResultsWindow.find('.pagination-rtypes-list').val(JSON.stringify(rtype_list));
        $paginationParent = $currentResultsWindow.find('.query-pagination .pagination-container');
        console.log($paginationParent);
        //show our container
        $paginationParent.show();
        
        //Clear our container
        $paginationParent.empty();
        
        //setup the vars for the first/previous page buttons
        var first = 1; //This will always be 1
        console.log("I'm losing my f**** mind. What is : " + currentPage);
        if (currentPage == "ALL"){
            var previous = 1;
            var last = 1;
            var next = 1;
        } else {
            var previous = parseInt(currentPage) - 1;
            //if the prveious page is less than 1, e.g. if the current page is one, then set it to 1
            if (previous < 1) previous = 1;
        
            //setup the vars for the next/last page buttons
            var last = Math.ceil(numOfResults / resultsPerPage);//This is just chopping the remainder off our quotient to get our final page
            var next = parseInt(currentPage) + 1;
            if(next > last) next = last;
        }
        //setup our results option div
        $paginationParent.append($('<button class="btn see-all-results" type="button" title="Load All Results" page="ALL" onclick="requestNewPageFromServer(this)"><span class="glyphicon glyphicon-eye-open">ALL</span></button>'))
        
        //Now add all of our pagination buttons
        
        $paginationParent.append($('<button class="btn page-control" type="button" page="'+first+'" onclick="requestNewPageFromServer(this)"><span class="glyphicon glyphicon-step-backward">|<</span></button>'));
        $paginationParent.append($('<button class="btn page-control" type="button" page="'+previous+'" onclick="requestNewPageFromServer(this)"><span class="glyphicon glyphicon-backward"><<</span></button>'));

        //setup 4 previous page buttons 
        for(i = 4; i > 0;i--){
            var pageNum;
            if (currentPage == "ALL") pageNum = 1;
            else pageNum = parseInt(currentPage) - i;
            //If the page number is less than 1--make an empty div with ...'s
            if (pageNum < 1 || currentPage =="ALL") $paginationParent.append($('<div class="page-button-empty">. . .</div>'));
            //else make a proper page number button with a working link etc.
            else $paginationParent.append($('<button class="btn page-button" type="button" page="'+pageNum+'" onclick="requestNewPageFromServer(this)">'+pageNum+'</button>'));
        }
        
        // Create the empty current page DIV
        $paginationParent.append($('<div class="page-button current-page">'+currentPage+'</div>'))
        
         //setup 4 next page buttons 
        for(i = 1; i < 5;i++){
            var pageNum;
            if (currentPage == "ALL") pageNum = 1;
            else pageNum = parseInt(currentPage) + i;
            //If the page number is less than 1--make an empty div with ...'s
            if (pageNum > last || currentPage =="ALL") $paginationParent.append($('<div class="page-button-empty">. . .</div>'));
            //else make a proper page number button with a working link etc.
            else $paginationParent.append($('<button class="btn page-button" type="button" page="'+pageNum+'" onclick="requestNewPageFromServer(this)">'+pageNum+'</button>'));
        }       
        
        //Finally, append the last two next/last buttons
        $paginationParent.append($('<button class="btn page-control" type="button" page="'+next+'" onclick="requestNewPageFromServer(this)"><span class="glyphicon glyphicon-forward">>></span></button>'));        
        $paginationParent.append($('<button class="btn page-control" type="button" page="'+last+'" onclick="requestNewPageFromServer(this)"><span class="glyphicon glyphicon-step-forward">>|</span></button>'));
        
        //setup our stats div
        $paginationParent.append($('<div class="stats">'+last+' pages<br>'+numOfResults+' results</div>'))
        
    }

    function requestNewPageFromServer(currentButton){
        var pageNumber = $(currentButton).attr('page');
        $currentParentWindow = $(currentButton).parent().parent().parent();
        var queryToResend = $currentParentWindow.find('.pagination-query-json').val();
        var numOfResults =  $currentParentWindow.find('.pagination-results-count').val();
            
        formData = [];
        progress_uuid=gen_uuid()
        formData.push({name: 'uuid', value: progress_uuid});
        formData.push({name: 'currentQueryJSON', value: queryToResend});
        formData.push({name: 'requestedPageNumber', value: pageNumber});
        formData.push({name: 'resultsPerPage', value: '25'});
        formData.push({name: 'numberOfResults', value: numOfResults});
        formData.push({name: 'form_list', value: $currentParentWindow.find('.pagination-results-list').val() });
        formData.push({name: 'formtype_id', value: $currentParentWindow.find('.query-stats').attr('formtype_pk')});
        formData.push({name: 'project_id', value: $currentParentWindow.find('.query-stats').attr('project_pk')});
        formData.push({name: 'pagination_rtype_header', value: $currentParentWindow.find('.pagination-rtypes-list').val()});
        showBusyGraphic($('#view-table'));
        
        $.ajax({ 
             url   : API_URLS['run_master_query_pagination'],
             type  : "POST",
             data  : formData, // data to be submitted
             success : function(returnedQuery)
             {
                console.log(returnedQuery);
                
                
                var $progressBar = $('#query-progress-bar');
                $progressBar.addClass('progress-bar-success');
                $progressBar.removeClass('progress-bar-striped');
                $progressBar.css('width', 100+'%');
                $progressBar.html(100+'% -- Database Import Finished');
                $progressBar.attr('aria-valuenow', 100); 
                $currentParentWindow.find('.view-table-body').children().first().empty();
                //Setup our initial pagination
                console.log(returnedQuery.pagination_rtype_header);
                buildPageNavigationBar(returnedQuery.resultsCount, returnedQuery.pagination_page, returnedQuery.currentQuery, $currentParentWindow, returnedQuery.pagination_form_list, returnedQuery.pagination_rtype_header);
                //Create the new table of the query results
                rebuildQueryResultsTable(returnedQuery, $currentParentWindow);
                //remove busy indicator
                removeBusyGraphic();

             },
                // handle a successful response
                done : function(json) {
                  
                    console.log("!!!!!!!!!!!!!!!!"); // log the returned json to the console
                    console.log("success"); // another sanity check
                },

                // handle a non-successful response
                fail : function(xhr,errmsg,err) {
                    $('#info-message').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                        " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                    console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                }
        });
        alreadyHaveStats = true;
        
        queryFinishedFasterThanAJAXCall = false
        //Start our progress check
        //window.setTimeout(update_progress_info, freq);
    }
    
    function rebuildQueryResultsTable(results, currentResultsParent){
        $currentResultsParent = $(currentResultsParent);
        
        $currentResultsParent.find('.query-stats').attr('formtype_pk', results.formtype_pk);
        $currentResultsParent.find('.query-stats').attr('project_pk', results.project_pk);
        
        //Setup the necessary DOM variables
        $queryTable = $currentResultsParent.find('.view-table-body').children().first();
        //Build the header
        console.log($currentResultsParent);
        console.log(results);
        var $headerRow = $('<tr class="header-row"></tr>');
        $queryTable.append($headerRow);
        $headerRow.append('<td>Preview</td>');
        $headerRow.append('<td>' + results.formtype + '</td>');
        for(i = 0; i < results.rtype_header.length;i++) {
            value = results.rtype_header[i].name;
            if(results.rtype_header[i].rtype == 'frat')$headerRow.append('<td title="'+value+'"><div><span>'+value+'</span></div></td>');    
            else $headerRow.append('<td title="'+value+'"><div><span>'+value+'</span></div></td>');    
        }
        //build the individual form rows and append them to the newly cleared table
        for(row=0; row < results.form_list.length;row++){
            var $newRow = $('<tr></tr>');
            var $currentForm = results.form_list[row];
            $queryTable.append($newRow);
            //Now add all the relevant columns ofinformation
            //Add the thumbnail link
            //First see if it's a 'NO Preview" -- if it is, then add the IMG-404 class--we don't want to show it as a big pop up
            if($currentForm.thumbnail_URI.search('no-thumb-missing.png') != -1 ){
                $newRow.append('<td><a href="#"><img class="enki-img-popup IMG-404" src="' + $currentForm.thumbnail_URI +'"></img></a></td>');
            //Otherwise add it as normal
            }else{
                $newRow.append('<td><img class="enki-img-popup" src="' + $currentForm.thumbnail_URI +'" onError="this.onerror=null;this.src=\'{% static 'site-images/no-thumb-missing.png'%}\';this.classList.add(\'IMG-404\');"></img></td>');
            }       
            //Add the form id link
            $newRow.append('<td style=""><a href="http://'+ document.location.hostname +'/admin/project/' + results.project_pk +'/formtype/' + results.formtype_pk + '/form_editor/' + $currentForm.pk + '/">' + results.formtype +': ' + $currentForm.form_id + '</a><button class="btn form-quick-view" type="button" form_pk="'+$currentForm.pk+'" formtype_pk="'+results.formtype_pk+'" project_pk="'+results.project_pk+'" title="Check out form data" onclick="previewForm(this)"><span class="glyphicon glyphicon-eye-open">ʘ</span></button></td>');
            //now add each individual column from the query results
            for(col=0; col < $currentForm.rvals.length;col++){
               $thisRval = $currentForm.rvals[col];
               //If we're working with a FRAT (Form Record Attribute Value) or a 'frrv-ext' value then just display the text
               if($thisRval.rtype != "frrv"){
                   if($thisRval.value.length < 40){$newRow.append('<td><div><span class="frav_view" {% if user_access >= access_level %} onclick="editIndividualRecord(this)" {% endif %} >'+ $thisRval.value.replace(/,/g, ",&nbsp;") +'</span>{% if user_access >= access_level %}<textarea form="find-replace-form" class="frav_edit" name="frav__'+$thisRval.pk+'" oninput="flagTextareaAsChanged(this)" style="display:none"  disabled>'+ $thisRval.value.replace(/,/g, ",&nbsp;") +'</textarea>{% endif %} </div></td>');}
                   else{$newRow.append('<td><div style="overflow-y:scroll;"><span class="frav_view" {% if user_access >= access_level %} onclick="editIndividualRecord(this)" {% endif %} >'+ $thisRval.value.replace(/,/g, ",&nbsp;") +'</span>{% if user_access >= access_level %}<textarea form="find-replace-form" class="frav_edit" name="frav__'+$thisRval.pk+'" oninput="flagTextareaAsChanged(this)" style="display:none"  disabled>'+ $thisRval.value.replace(/,/g, ",&nbsp;") +'</textarea>{% endif %}</div></td>');}
               //Otherwise we are dealing with a FRAV   reference type, and we need to parse out the list of names and make them links
               } else {
                   var FRRVlist = $thisRval.value.split("^,^");
                   var parsedHTML = ""; 
                   for(i=0; i<FRRVlist.length;i++){parsedHTML+='<a class="relation-link" href="http://'+ document.location.hostname +'/admin/project/' + results.project_pk +'/formtype/' + FRRVlist[i].split("|^|")[1] + '/form_editor/' + FRRVlist[i].split("|^|")[2] + '/">' + FRRVlist[i].split("|^|")[0] + '</a>';}
                   $newRow.append('<td>' + parsedHTML + '</td>');
               }
            }
        }
        
        
        //Activate the iamge popup for the thumbnails
        //--This will require the enki-thumbnail-popup.js to be included on this page
        updateImagePopup();
    }        
    
    
// Generate 32 char random uuid 
function gen_uuid() {
    var uuid = ""
    for (var i=0; i < 32; i++) {
        uuid += Math.floor(Math.random() * 16).toString(16); 
    }
    return uuid
} 





    $('#master-query-engine .query-engine').submit( function(e){
        PROGRESS_UUID = gen_uuid();
        e.preventDefault(); // Keep the form from submitting
        querydata = convertQueryToJSON();
        $.ajax({ url   : API_URLS['run_master_query_engine'], timeout: 3200000, type  : "GET", data  : [{name:"master_query", value:querydata}, {name: 'uuid', value: PROGRESS_UUID}], // data to be submitted
             success : function(returnedQuery){
                console.log(returnedQuery);
/*                GLOBAL_CURRENT_QUERY = returnedQuery;
                queryFinishedFasterThanAJAXCall = true;
                $('#all-results').empty();
                for (var i=0; i < returnedQuery.length; i++){
                    //Create a new project query results window
                    $newResultsWindow = $('.project-results-clone').clone(true);
                    $newResultsWindow.show();
                    $newResultsWindow.removeClass('project-results-clone');
                    $('#all-results').append($newResultsWindow);
                    
                    var currentProject = returnedQuery[i];
                    $newResultsWindow.find('.query-title').text(currentProject.project + " : " + currentProject.formtype);
                    console.log($('.all-queries').children().eq(i).css('border-color'));
                    $newResultsWindow.css('border-color', $('.all-queries').children().eq(i).css('border-color'));
                    
                    //Setup our initial pagination
                    console.log(currentProject.pagination_rtype_header);
                    buildPageNavigationBar(currentProject.totalResultCount, 1, currentProject.currentQuery, $newResultsWindow[0], currentProject.pagination_form_list, currentProject.pagination_rtype_header);
                    //Create the new table of the query results
                    rebuildQueryResultsTable(currentProject, $newResultsWindow[0]);
                    //Create Chart
                    createNewChart(currentProject.query_stats,$newResultsWindow[0]);
                }*/
              },
              error: function(jqXHR, textStatus, errorThrown){
                        console.log(errorThrown);
                        console.log(jqXHR);
                        console.log(textStatus)
                    if(textStatus==="timeout") {  
                        console.log(errorThrown);
                        console.log(jqXHR);
                        console.log(textStatus)
                        //alert("Call has timed out"); //Handle the timeout
                        console.log(errorThrown);
                        console.log(jqXHR);
                        console.log(textStatus)
                    } else {
                                            console.log(errorThrown);
                        console.log(jqXHR);
                        console.log(textStatus)
                        //alert("Another error was returned"); //Handle other error type
                        console.log(errorThrown);
                        console.log(jqXHR);
                        console.log(textStatus)
                    }
              }
        });
        
            //Start our progress check
        window.setTimeout(update_progress_info, 1000);
    });
 
     function update_progress_info() {
        console.log("Trying again?");
        $.getJSON(API_URLS.run_check_progress_query, {'uuid': PROGRESS_UUID}, function(data, status){
            console.log("UPDATE PROGRESS FUNCTION");
            console.log(status);
            //console.log(data);
            console.log(queryFinishedFasterThanAJAXCall);
            //console.log(status);
            if (data) {
                console.log(data);
                var $progressBar = $('#query-progress-bar');
                var progress = data.percent_done;
                if (data.is_complete == 'True'){
                    $progressBar.addClass('progress-bar-success');
                    $progressBar.removeClass('progress-bar-striped');
                    $progressBar.css('width', 100+'%');
                    $progressBar.html(100+'% -- '+ data.message);
                    $progressBar.attr('aria-valuenow', '100');  
                    queryFinishedFasterThanAJAXCall = false;
                        GLOBAL_CURRENT_QUERY = data.completed_process_data;
                        $('#all-results').empty();
                        for (var i=0; i < data.completed_process_data.length; i++){
                            //Create a new project query results window
                            $newResultsWindow = $('.project-results-clone').clone(true);
                            $newResultsWindow.show();
                            $newResultsWindow.removeClass('project-results-clone');
                            $('#all-results').append($newResultsWindow);
                            
                            var currentProject = data.completed_process_data[i];
                            
                            $newResultsWindow.find('.query-title').text(currentProject.project + " : " + currentProject.formtype);
                            console.log($('.all-queries').children().eq(i).css('border-color'));
                            $newResultsWindow.css('border-color', $('.all-queries').children().eq(i).css('border-color'));
                            
                            //Setup our initial pagination
                            console.log(currentProject.pagination_rtype_header);
                            buildPageNavigationBar(currentProject.totalResultCount, 1, currentProject.currentQuery, $newResultsWindow[0], currentProject.pagination_form_list, currentProject.pagination_rtype_header);
                            //Create the new table of the query results
                            rebuildQueryResultsTable(currentProject, $newResultsWindow[0]);
                            //Create Chart
                            createNewChart(currentProject.query_stats,$newResultsWindow[0]);
                        }                    
                } else if( data.percent_done != '0' && queryFinishedFasterThanAJAXCall == false){
                    $progressBar.addClass('progress-bar-striped');
                    $progressBar.removeClass('progress-bar-success');
                    $progressBar.css('width', progress+'%');
                    $progressBar.html(progress+'% -- '  + data.message +"   :   "+ data.current_query +"   Current Term:   "+ data.current_term +"   Current Constraint:   "+ data.current_constraint);
                    $progressBar.attr('aria-valuenow', progress);
                } else {
                    $progressBar.css('width', 0+'%');
                    $progressBar.html(0+'% -- Starting...');
                    $progressBar.attr('aria-valuenow', 0);
                }
                
                if(data.hasOwnProperty('stats') && alreadyHaveStats != true){
                    //Make sure we only do this once
                    alreadyHaveStats = true;
                    //Create the new charts of the query results
                    //createNewChart(data.stats);
                }
                
                if(data.hasOwnProperty('ERROR')){
                    errorcount++;
                } else {
                    errorcount = 0;
                }
                
            }
            if (data.is_complete == 'False' && errorcount <= 5){
                //console.log("restarting window timeout");
                window.setTimeout(update_progress_info, 1000);
                //console.log("pretty sure we just set the timer to run another test");
            }
        });
    };
 
 
    function convertQueryToJSON(){
        var masterQuery = {}
        var queryList = []
        masterQuery['query_list'] = queryList;
        
        
        //Load all the project queries
        $('#master-query-engine .all-queries').children().each( function() {
                $currentQuery = $(this);
                var projectQuery = {};
                console.log(this);
                console.log('Trying to query now!');
                //Setup our initial query values
                projectQuery['project_pk'] = $currentQuery.find('.query-project select').val();
                projectQuery['project_label'] = $currentQuery.find('.query-project select option:selected').text();
                projectQuery['formtype_pk'] = $currentQuery.find('.query-terms .formtype-list').val();
                projectQuery['formtype_label'] = $currentQuery.find('.query-terms .formtype-list option:selected').text();
                
                //Now let's store all the query information. The first query term will be in the 'query-terms' div, and then we'll
                //  --loop through the and-or-container div to grab the rest of the terms
                allTerms = [];
                projectQuery['terms'] = allTerms;
                initialTerm = {};
                initialTerm['RTYPE'] = $currentQuery.find('.query-terms .rtype-list').val().split('__')[1];
                initialTerm['QCODE'] = $currentQuery.find('.query-terms .__QCODE').val();
                initialTerm['TVAL'] = $currentQuery.find('.query-terms .__TVAL').val();
                initialTerm['LABEL'] = $currentQuery.find('.query-terms .rtype-list option:selected').text();
                initialTerm['pk'] = $currentQuery.find('.query-terms .rtype-list').val().split('__')[0];
                initialTerm['ANDOR'] = 'INITIAL';
                if (initialTerm['RTYPE'] == "FRRT"){
                    console.log($currentQuery.find('.deep-rtype-list option:selected').val());
                    initialTerm['RTYPE-DEEP'] = $currentQuery.find('.deep-rtype-list option:selected').val();
                }
                allTerms.push(initialTerm);
                //Loop through the rest of the query terms if there are any
                $currentQuery.find('.and-or-container').children().each( function() {
                    $currentTerm = $(this);
                    console.log(this);
                    console.log("--------------------------------");
                    newTerm = {};
                    newTerm['RTYPE'] = $currentTerm.find('.rtype-list').val().split('__')[1];
                    newTerm['QCODE'] = $currentTerm.find('.__QCODE').val();
                    newTerm['TVAL'] = $currentTerm.find('.__TVAL').val();
                    newTerm['LABEL'] = $currentTerm.find('.rtype-list option:selected').text();
                    newTerm['pk'] = $currentTerm.find('.rtype-list').val().split('__')[0];
                    newTerm['ANDOR'] = $currentTerm.find('.__ANDOR').val();
                    if (newTerm['RTYPE'] == "FRRT"){
                        console.log($currentTerm.find('.deep-rtype-list option:selected').val());
                        newTerm['RTYPE-DEEP'] = $currentTerm.find('.deep-rtype-list option:selected').val();
                    }
                    allTerms.push(newTerm);
                });

                ///////////////////////////////////////////////////////////////////////////////////
                // We're going to load all the constraints--if any now.
                
                //First PRIMARY constraints
                var currentPrimary = {};
                $currentPrimaryElement = $(this).find('.constraints-list.primary');
                
                currentPrimary['RTYPE'] = $currentPrimaryElement.find('.rtype-list').val().split('__')[1];
                currentPrimary['QCODE'] = $currentPrimaryElement.find('.__QCODE').val();
                currentPrimary['LABEL'] = $currentPrimaryElement.find('.rtype-list option:selected').text();
                currentPrimary['pk'] = $currentPrimaryElement.find('.rtype-list').val().split('__')[0];
                if (currentPrimary['RTYPE'] == "FRRT"){
                        currentPrimary['RTYPE-DEEP'] = $currentPrimaryElement.find('.deep-rtype-list option:selected').val();
                }
                var primaryConstraints = [];
                if (currentPrimary['QCODE'] == 5){primaryConstraints.push("ALL UNIQUE TERM SEARCH");//Load a blank/arbitrary term to ensure we have 'a' primary term to trigger the server to use it
                } else { //otherwise make sure we send a completely EMPTY 
                    $currentPrimaryElement.find('.inputs').children().each( function() {
                        $currentTerm = $(this);
                        console.log(this);
                        var value = $currentTerm.find('.__TVAL').val();
                        if (value && value != "") primaryConstraints.push(value);//only add a value from our term boxes IF it is not blank or null etc.
                    });
                }
                currentPrimary['terms'] = primaryConstraints;
                projectQuery['primary_constraints'] = currentPrimary;
                
                //Now SECONDARY constraints
                var currentSecondary = {};
                $currentSecondaryElement = $(this).find('.constraints-list.secondary');
                
                currentSecondary['RTYPE'] = $currentSecondaryElement.find('.rtype-list').val().split('__')[1];
                currentSecondary['QCODE'] = $currentSecondaryElement.find('.__QCODE').val();
                currentSecondary['LABEL'] = $currentSecondaryElement.find('.rtype-list option:selected').text();
                currentSecondary['pk'] = $currentSecondaryElement.find('.rtype-list').val().split('__')[0];
                if (currentSecondary['RTYPE'] == "FRRT"){
                        currentSecondary['RTYPE-DEEP'] = $currentSecondaryElement.find('.deep-rtype-list option:selected').val();
                }
                var secondaryConstraints = [];
                if (currentSecondary['QCODE'] == 5){secondaryConstraints.push("ALL UNIQUE TERM SEARCH");//Load a blank/arbitrary term to ensure we have 'a' primary term to trigger the server to use it
                } else {//otherwise make sure we send a completely EMPTY 
                    $currentSecondaryElement.find('.inputs').children().each( function() {
                        $currentTerm = $(this);
                        console.log(this);
                        var value = $currentTerm.find('.__TVAL').val();
                        if (value && value != "") secondaryConstraints.push(value);//only add a value from our term boxes IF it is not blank or null etc.
                    });
                }
                currentSecondary['terms'] = secondaryConstraints;
                projectQuery['secondary_constraints'] = currentSecondary;
                
                
            queryList.push(projectQuery);
        });
        
        console.log(masterQuery);
        return JSON.stringify(masterQuery);
        
    }
 
    $('.delete-query').click( function(){
        if ( $(this).parent().parent().parent().children().length > 1){
            $(this).parent().parent().remove();
            var currentQueryID = $(this).parent().parent().attr('queryid');
            $('.constraints-container').find('[queryid="'+currentQueryID+'"]').remove();
            adjustConstraintHeight();
        }  
    });
 
    $('.and-or-add-btn').click(function(){
        $newTerm = $('.term-clone').clone();
        $newTerm.show();
        $newTerm.removeClass('term-clone');
        console.log(this);
        $(this).parent().find('.and-or-container').append($newTerm);  
        adjustConstraintHeight();
        //Let's replace the __RTYPE select with the one that already exists
        $parent = $(this).parent().find('.and-or-container .__RTYPE').last().parent();
        console.log($parent);
        $parent.empty();
        console.log($(this).parent().find('.query-container .__RTYPE'));
        $parent.append( $(this).parent().find('.query-container .__RTYPE').clone(true) );
        $newTerm.find('.delete-term').click( function(){
            $(this).parent().parent().remove();
            adjustConstraintHeight();
        });
        
    });
    
    function adjustConstraintHeight(){
        //first set the constraints container to the height of the query div
        //$('.constraints-container').height($('.all-queries').height());
        //Loop through each project query and look for its matching constraints and adjust their positions collectively
        //$('.all-queries').children().each( function(){
        //    $('.constraints-container').find('[queryID="'+$(this).attr('queryID')+'"]').css('top',$(this).position().top);
        
        //});
    
    }

    var queryCounter = 0;
    
    $('#add-query').click( function(){addNewProjectQuery()});


    function addNewProjectQuery(){
        $newQuery = $('.single-query-clone').clone(true);
        var randomColor = "rgb("+Math.floor((Math.random() * 255) + 50)+","+Math.floor((Math.random() * 255) + 50)+","+Math.floor((Math.random() * 255) + 50)+")";
        $newQuery.css('border-color', randomColor);
        $newQuery.removeClass('single-query-clone');
        $newQuery.attr('queryID', queryCounter);
        $newQuery.show();
        console.log(this);
        $('.all-queries').append($newQuery);  

        queryCounter++;

        //Load the Projects
        $.ajax({ url   : API_URLS['get_projects'], type  : "GET", data  : [], // data to be submitted
             success : function(returnedQuery){
                console.log(returnedQuery);
                //First add the projects to the list when finished
                for (var i = 0; i < returnedQuery.project_list.length; i++){
                    $newQuery.find('.project-list').append('<option value="'+returnedQuery.project_list[i].pk+'">'+returnedQuery.project_list[i].name+'</option>');
                }
                QUERY_LOAD_FINISHED = true;
                console.log("Just loaded all the projects for the select");
             }
        });
        
        //Next, add the onchange listener for the select, so that it starts the ajax request to populate the form types for the selected project
        $newQuery.find('.project-list').change( function(){
            $formtype_select = $(this).parent().parent().find('.formtype-list');
            $formtype_select.empty();
            $formtype_select.prop('disabled', true);
            $rtype_select = $(this).parent().parent().find('.rtype-list');
            $rtype_select.prop('disabled', true);
            $rtype_select.empty();
            //Only do an ajax request IF they've selected an actual project, otherwise disable the formtype select
            if ($(this).val() != "none"){
                //Load the FormTypes
                $.ajax({ url   : API_URLS['get_formtypes'], type  : "GET", data  : [{name:"project_pk", value:$(this).val()}], // data to be submitted
                     success : function(returnedQuery){
                        //console.log(returnedQuery);
                        //First add the formtypes to the list when finished
                        for (var i = 0; i < returnedQuery.formtype_list.length; i++){
                            $formtype_select.append('<option value="'+returnedQuery.formtype_list[i].pk+'">'+returnedQuery.formtype_list[i].name+'</option>');
                        }
                        //Now enabled the select box
                        $formtype_select.prop('disabled', false);
                        $formtype_select.change();
                        console.log("Just loaded all the formtypes in the select");
                        QUERY_LOAD_FINISHED = true;
                     }
                });
            } else {
                
            }
        });
        
        //Next, add the onchange listener for the formtype select, so that it starts the ajax request to populate the rtypes for the selected project
        $newQuery.find('.formtype-list').change( function(){
            console.log("We're in the __FT change listener now--should be sending an AJAX request");
            $rtype_select = $(this).parent().parent().find('.rtype-list');
            $rtype_select.prop('disabled', true);
            $(this).parent().parent().parent().parent().find('.rtype-list').empty();
            $parentQuery = $(this).parent().parent().parent();
            var currentID = $(this).parent().parent().parent().attr('queryid');
            //Only do an ajax request IF they've selected an actual project, otherwise disable the formtype select and reset it to empty
            if ($(this).val() != "none"){
                //Load the FormTypes
                $.ajax({ url   : API_URLS['get_rtypes'], type  : "GET", data  : [{name:"formtype_pk", value:$(this).val()}], // data to be submitted
                     success : function(returnedQuery){
                        console.log(returnedQuery);
                        $rtype_select.empty();
                        $rtype_select.append($('<option value="0__FORMID">'+$parentQuery.find('.__FT option:selected').text()+' ID</option>'));
                        //First add the projects to the list when finished
                        for (var i = 0; i < returnedQuery.rtype_list.length; i++){
                            $newOption = $('<option value="'+returnedQuery.rtype_list[i].pk+'__'+returnedQuery.rtype_list[i].rtype+'">'+returnedQuery.rtype_list[i].label+'</option>');
                            if (returnedQuery.rtype_list[i].rtype == "FRRT") {$newOption.addClass('FRRT-option');}
                            $rtype_select.append($newOption);
                        }
                        //now enabled the select box
                        $rtype_select.prop('disabled', false);                      
                        if (!$rtype_select.hasClass('loaded')){$rtype_select.change();console.log("*************************************************CHANGING RTYPE  "+$rtype_select.hasClass('loaded'))} //Only activate a change if we AREN'T loading a query
                        
                        //Let's replace all the  __RTYPE selects in the and-or-term container
                        //console.log($parentQuery);
                        $allTermRtypes = $parentQuery.find('.and-or-container .new-term');
                        //console.log($allTermRtypes);
                        $allTermRtypes.each( function() {
                            $currentRtype = $(this).find('.__RTYPE');
                            //console.log($currentRtype);
                            $parentRtype = $currentRtype.parent();
                            $currentRtype.remove();
                            $parentRtype.append($rtype_select.clone(true));
                        });                        
                        //Let's replace the __RTYPE selects in the constraint containers with the one that already exists in the parent query
                        console.log($parentQuery);
                        $parentQuery.parent().find('.constraints-list .__RTYPE').each( function() {
                            console.log($(this));
                            $rtypeParent = $(this).parent();
                            $(this).remove();
                            $rtypeParent.prepend($rtype_select.clone(true));
                        });
                        QUERY_LOAD_FINISHED = true;
                        console.log("FINISHED LOADING FORMTYPES FROM CHANGE() function AJAX");
                     }
                });
            } else {

            }

            
            
        });
        
        //Next, add the onchange listener for the rtype select, so that it starts the ajax request to populate the deep rtypes for the selected frrt -- if an frrt
        $newQuery.find('.rtype-list').change( function(){   
            console.log($(this).val());
            console.log($(this)[0]);
            var $deep_rtype_select = $(this).parent().parent().find('.deep-rtype-list');
            $deep_rtype_select.prop('disabled', true);
            $deep_rtype_select.empty();
            $currentQuery = $(this).parent().parent();
            var currentID = $(this).parent().parent().parent().attr('queryid');
            //console.log($(this).parent().parent());
            //console.log($(this).find(":selected"));
            var frrtToLookup = $(this).find(":selected").val().split('__');
            var formtype_label = $(this).find('option:selected').text();
            $thisRTYPE = $(this);
            console.log(frrtToLookup[1]);
            if (frrtToLookup[1] == "FRRT") {
                
                if ($(this).find(":selected").val() != "none"){
                    //var $currentSelect = $(this).parent().parent().find('.deep-rtype-list');
                    //Load the FormTypes
                    $.ajax({ url   :  API_URLS['get_rtypes'], type  : "GET", data  : [{name:"frrt-pk", value: frrtToLookup[0]}], // data to be submitted
                         success : function(returnedQuery){
                            console.log(returnedQuery);
                            $deep_rtype_select.empty();
                            $deep_rtype_select.append('<option value="0__FORMID">'+formtype_label+' ID</option>');
                            //First add the projects to the list when finished
                            for (var i = 0; i < returnedQuery.rtype_list.length; i++){
                                $deep_rtype_select.append('<option value="'+returnedQuery.rtype_list[i].pk+'__'+returnedQuery.rtype_list[i].rtype+'">'+formtype_label + ' :: ' +returnedQuery.rtype_list[i].label+'</option>');
                            }
                            //now enabled the select box
                            $deep_rtype_select.prop('disabled', false);
                            //Let's replace all the  __RTYPE-DEEP selects in the and-or-term container
                            $allTermRtypes = $currentQuery.find('.and-or-container .new-term').each( function() {
                                $currentRtype = $(this).find('.__RTYPE-DEEP');
                                //console.log($currentRtype);
                                $parentRtype = $currentRtype.parent();
                                $currentRtype.remove();
                                $parentRtype.append($currentQuery.find('.query-terms .__RTYPE').clone(true));
                            });                        
                            QUERY_LOAD_FINISHED = true;
                            if ($deep_rtype_select.parent().parent().hasClass('constraints-list')){
                            
                                $deep_rtype_select.addClass('loaded');
                                if ($('.constraints-list.primary').find('.__RTYPE-DEEP').hasClass('loaded') && $('.constraints-list.secondary').find('.__RTYPE-DEEP').hasClass('loaded')){ ALL_CONSTRAINTS_DEEP_LOADED = true;}
                            }
                         }
                         
                         
                    });
                } else { QUERY_LOAD_FINISHED = true;}
            } else {
            console.log($(this).parent().parent()[0]);
                if ($(this).parent().parent().hasClass('constraints-list')){
                    $(this).parent().parent().find('.__RTYPE-DEEP').addClass('loaded');
                    if ($('.constraints-list.primary').find('.__RTYPE-DEEP').hasClass('loaded') && $('.constraints-list.secondary').find('.__RTYPE-DEEP').hasClass('loaded')){ ALL_CONSTRAINTS_DEEP_LOADED = true;}
                }
            }
        });
    }


     
    function showBusyGraphic(elementToCover){
        $busyIndicator = $('<div id="busy-indicator"><img src="{% static 'site-images/busy-indicator.gif' %}"></img></div>');
        $(elementToCover).append($busyIndicator);
    }
    
    function removeBusyGraphic(){
        $('#busy-indicator').remove();
    }
    
    
   

    $('.add-constraint-term').click( function() {
        $newInput = $('.constraint-input.TEMPLATE').clone(true);
        $newInput.removeClass('TEMPLATE');
        $newInput.show();
        $(this).parent().find('.inputs').append($newInput)
    });
    
    $('.delete-constraint-term').click( function() {
        $(this).parent().remove();
    });
    



    $('.tab-button').click( function(){
        $(this).parent().parent().find('.tab-content').css('z-index', '1'); //reset all to 1
        $(this).parent().parent().find('.tab-button').removeClass('selected');
        $(this).parent().find('.tab-content').css('z-index', '10'); //set this to the highest level
        $(this).addClass('selected');
    
    });
    
    
    




   
  


    $(document).ready(function() { 
    addNewProjectQuery();
    loadAllSavedUserQueries();
    vanillaQuery = '{"query_list":{"query_1":{"LABEL":"Object ID","RTYPE":"FORMID-0","Q-ANDOR":"NULL","TERMS":[{"T-ANDOR":"NULL","QCODE":"0","TVAL":""}]}},"constraint_list":{"constraint_1":{"LABEL":"Object ID","RTYPE":"FORMID-0","QCODE":"0","TVAL":""}}}';
    {% if starter_query %}
        vanillaQuery = {{starter_query|safe}};
        console.log(vanillaQuery)

    
        querydata = JSON.stringify(vanillaQuery);
        $.ajax({ url   : API_URLS['run_master_query_engine'], type  : "GET", data  : [{name:"master_query", value:querydata}, {name: 'uuid', value: gen_uuid()}], // data to be submitted
             success : function(returnedQuery){
                console.log(returnedQuery);
                GLOBAL_CURRENT_QUERY = returnedQuery;
                $('#all-results').empty();
                for (var i=0; i < returnedQuery.length; i++){
                    //Create a new project query results window
                    $newResultsWindow = $('.project-results-clone').clone(true);
                    $newResultsWindow.show();
                    $newResultsWindow.removeClass('project-results-clone');
                    $('#all-results').append($newResultsWindow);
                    
                    var currentProject = returnedQuery[i];
                    
                    //Setup our initial pagination
                    buildPageNavigationBar(currentProject.totalResultCount, 1, currentProject.currentQuery, $newResultsWindow[0], currentProject.pagination_form_list);
                    //Create the new table of the query results
                    rebuildQueryResultsTable(currentProject, $newResultsWindow[0]);
                    //Create Chart
                    createNewChart(currentProject.query_stats,$newResultsWindow[0]);
                }
              }
        });

    {% endif %}
    
    });
    // ***************************************END OF MASTER QUERY ENGINE ******************************************* 
    //----------------------------------------------------------------------------------------------------------------
    </script>    
{% endblock %}